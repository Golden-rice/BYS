<{extends file='../layout.html'}>

<{block name="title"}>计划任务<{/block}>
<{block name="content"}>

<div id="content"></div>
<!-- other modal -->
<div class="modal fade" id="otherModal" tabindex="-1" role="dialog" aria-labelledby="modalLabel" >
  <div class="modal-dialog modal-lg" role="document" style='width:1600px'>
    <div class="modal-content">

      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="modalLabel"> </h4>
      </div>
      <!-- modal header -->

      <div class="modal-body">
        <div id="modal-content">
            

        </div>
      </div>
      <!-- modal body -->

      <div class="modal-footer">
        <button type="button" class="btn btn-default hidden" data-dismiss="modal">关闭</button>
      </div>
      <!-- modal footer -->

    </div>
  </div>
</div>
<!-- other modal end -->

<script>
require(['eterm', 'dt'], function (eterm, dt){

// 弹出框   
var OtherModel = function(title, content, footer){

    $("#otherModal .modal-title").html(title);
    $("#otherModal #modal-content").html(content);
    $("#otherModal .modal-footer").html(footer ? footer:`<button type="button" class="btn btn-default hidden"  data-dismiss="modal">关闭</button>`);

    return {
        hide: function(){
        	$("#example").modal('hide');
        },
        show: function(){
            $("#otherModal").modal();
        },
        set: function(title, contetn, footer){
			    $("#otherModal .modal-title").html(title);
			    $("#otherModal #modal-content").html(content);
			    $("#otherModal .modal-footer").html(footer);
        }
    }
}

var tpl = {
	mkTable: mkTable,
	xfsdTpl: xfsdTpl,
	avhTpl: avhTpl,
}

// 弹出层 暴露至全局
var xfsdModal, avhModal, mixModal;

var cabin = [];    // 全局变量：目标舱位
		// xfsd_src,   // 全局变量：xfsd 原始数据
		// avh;        // 全局变量：avh

function uniqueXfsd(result){
	if(!result || result.length == 0) {
		return;
	}
	// 过滤重复舱位，保存最便宜的
	var tmpCabin = result[0].xfsd_Cabin,      // 临时舱位
			tmpXfsd = {},                         // 临时xfsd
			array = [];                           // 最后返回结果

	tmpXfsd[result[0].xfsd_Cabin] = result[0];  // 初始化

	// 去重
	for (var i in result){
		if(tmpCabin !== result[i].xfsd_Cabin && tmpXfsd[result[i].xfsd_Cabin] == undefined ){
			tmpXfsd[result[i].xfsd_Cabin] = result[i]
			tmpCabin = result[i].xfsd_Cabin;
		}
	}

	for (var j in tmpXfsd){
		array.push(tmpXfsd[j])
	}
	return array;
}

var setCommand = function(command){

	command.showHotCityPlan();
	// 全局变量
	var xfsdInGroup;    // xfsd 分组的全部数据
	var xfsdSmpInGroup; // xfsd 分组的全部数据
	var	hid;            // 当前混舱的hotcity id 
	var hotcity;        // 热门城市数据



	// 查询全部且分组的 xfsd
	var searchXfsdResultByHotcity = new command.ReqCommand({
		url: eterm.const.Controller + 'searchXfsdResultByHotcity',
		clk: function(res){
			if(res.msg)
				alert(res.msg)

			if(res.status){
				xfsdInGroup    = res.inGroupResult
				xfsdSmpInGroup = res.inGroupSmpResult
				
				var	allFareModal     = new OtherModel("运价结果", xfsdTable(xfsdInGroup, 'xfsd-result-model'));
					allFareModal.show();
				
			}
		}
	}) 


	// 查询精简且分组的 xfsd
	var searchSmpXfsdResultByHotcity = new command.ReqCommand({
		url: eterm.const.Controller + 'searchXfsdResultByHotcity',
		clk: function(res){
			if(res.msg)
				alert(res.msg)

			if(res.status){
				// var inGroupSmpResult = [];
				// xfsdInGroup = res.inGroupResult
				// for(var i in res.inGroupResult){
				// 	inGroupSmpResult.push(uniqueXfsd(res.inGroupResult[i]))
				// }
				xfsdSmpInGroup = res.inGroupSmpResult
				xfsdInGroup    = res.inGroupResult
				
				var	smpModal   = new OtherModel("精简运价结果", xfsdTable(xfsdSmpInGroup, 'xfsd-result-model'));
					smpModal.show();
				
			}
		}
	}) 


	// 查询政策基础数据规则
	var reqPriceSourceRule = new command.ReqCommand({
		url: eterm.const.Controller + 'searchPriceSourceRule',
		clk: function(res){
			if(res.status){
				var a = new OtherModel("回填销售日期", mkSaleDateInsertTableFromPrice(res.result), `<button type="button" class="btn btn-primary" data-dismiss="modal" id='set-saleDate'>保存销售日期，并下一步</button><button type="button" class="btn btn-default hidden"  data-dismiss="modal">关闭</button>`);
				a.show();
			}
				
			if(res.msg)
				alert(res.msg);
		}
	}) 

	// 更新基础政策：销售日期
	var updatePriceSourceSaleDate = new command.ReqCommand({
		url: eterm.const.Controller + 'updatePriceSource',
		clk: function(res){
			if(res.msg)
				alert(res.msg)

			if(res.status){
				// mixModal.hide();
				setPriceSourceFlight.execute({'hid': hid})
			}
		}
	}) 

	// 更新基础政策：航班限制
	var updatePriceSourceFlight = new command.ReqCommand({
		url: eterm.const.Controller + 'updatePriceSource',
		clk: function(res){
			if(res.msg)
				alert(res.msg)

			if(res.status){
				// mixModal.hide();
				// searchPriceSource.execute({'hid': hid});
				// selectMixCabinTpl.execute({});
				window.open(eterm.const.Controller + 'mixcabin?hid='+hid)
			}
		}
	}) 

	// 选择混舱模板
	var selectMixCabinTpl = new command.ReqCommand({
		url: eterm.const.Controller + 'selectMixCabinTpl',
		clk: function(res){
			if(res.msg)
				alert(res.msg)

			if(res.status){
				console.log(res)
			}
		}
	}) 

	// 查询price source
	// var searchPriceSource = new command.ReqCommand({
	// 	url: eterm.const.Controller + 'searchPriceSource',
	// 	clk: function(res){
	// 		if(res.msg)
	// 			alert(res.msg)

	// 		if(res.status){
	// 			var ValidResult = mixCabin(res.result, hotcity);
	// 			console.log(res, ValidResult)
	// 			var c  = new OtherModel("混舱数据", mkMixCabinTable(ValidResult));
	// 			setTimeout(function(){
	// 				c.show();
	// 			},500)
	// 		}
	// 	}
	// }) 

	// 查询price source
	var setPriceSourceFlight = new command.ReqCommand({
		url: eterm.const.Controller + 'searchPriceSource',
		clk: function(res){
			if(res.msg)
				alert(res.msg)

			if(res.status){
				var testValidResult = mixCabin(res.result, hotcity, true)
				var b = new OtherModel("混舱测试数据", mkMixCabinTable(testValidResult), `<button type="button" class="btn btn-primary" id='set-flight' data-dismiss="modal">保存航班限制，并下一步</button><button type="button" class="btn btn-default"  data-dismiss="modal">关闭</button>`);
				setTimeout(function(){
					b.show();
				},500)
			}
		}
	}) 


	// 查看 xfsd
	$("#content").on("click", ".xfsd-result", function(){
		// xfsdModal = new OtherModel("运价结果", '');
		// command.searchXfsdResult({sid: $(this).data('sid')});
		var sid = $(this).data('sid'), sidArray = sid.split(','), has = false;
		if(xfsdInGroup){ 
			for(var i in sidArray){
				if(xfsdInGroup[sidArray[i]]) {
					has = true;
					break;
				}
			}
			if(has){
				mixModal  = new OtherModel("运价结果", xfsdTable(xfsdInGroup, 'xfsd-result-model'));
				mixModal.show();
			}else{
				searchSmpXfsdResultByHotcity.execute({'sid': sid});
			}
		}else{
			searchXfsdResultByHotcity.execute({'sid': sid});
		}
	})

	// 查看 avh
	$("#content").on("click", ".avh-result", function(){
		avhModal  = new OtherModel("舱位结果", '');
		command.searchAvhResult({'sid': $(this).data('sid')});
	})

	// 查看 简化结果
	$("#content").on("click", ".simplify-xfsd", function(){
		// xfsdModal = new OtherModel("精简运价结果", '');
		// command.searchXfsdResultByHotcity({sid: $(this).data('sid')})
		var sid = $(this).data('sid'), sidArray = sid.split(','), has = false;

		if(xfsdSmpInGroup){ 
			for(var i in sidArray){
				if(xfsdSmpInGroup[sidArray[i]]) {
					has = true;
					break;
				}
			}
			if(has){
				mixModal  = new OtherModel("精简运价结果", xfsdTable(xfsdSmpInGroup, 'xfsd-result-model'));
				mixModal.show();
			}else{
				searchSmpXfsdResultByHotcity.execute({'sid': sid});
			}
		}else{
			searchSmpXfsdResultByHotcity.execute({'sid': sid});
		}
	})

	// // 混舱 xfsd 临时
	// $("#content").on('click', '.mix-cabin', function(){
	// 	// 暴露全局变量
	// 	// 销售日期更新
	// 	hid     = $(this).data('id');
	// 	// 获得hotcity数据
	// 	hotcity = $(this).data('hotcity');

	// 	searchPriceSource.execute({'hid': hid})

	// })
	

	// 混舱 xfsd 
	$("#content").on('click', '.mix-cabin', function(){
		// 暴露全局变量
		// 销售日期更新
		hid     = $(this).data('id');
		// 获得hotcity数据
		hotcity = $(this).data('hotcity');

		reqPriceSourceRule.execute({'hid': hid});

	})

	// 销售日期的【下一步】
	$('#otherModal').on('click', '#set-saleDate', function(){
		// 更新
		if(hid != undefined){
			var saleDateInput = [];
			var ruleConditions = [];
			$('.saleDate').each(function(){
				ruleConditions.push($(this).data('rule'));
				saleDateInput.push($(this).val());
			})
			updatePriceSourceSaleDate.execute({
				'update': {
					'SaleDate': JSON.stringify(saleDateInput)
				}, 
				'where' : {
					'Rule': JSON.stringify(ruleConditions)
				},
				'Hid': hid,
			});

		}else{
			console.log('查询hotcity id 错误');
		}
	})

	// 混舱fsi测试的【下一步】
	$('#otherModal').on('click', '#set-flight', function(){
		// 更新
		if(hid != undefined){
			var flightInput = [];
			var farebasisConditions = [];
			$('.input-flight').each(function(){
				farebasisConditions.push($(this).data('farebasis'))
				flightInput.push($(this).val())

			})
			updatePriceSourceFlight.execute({
				'update': {
					'Flight': JSON.stringify(flightInput)
				}, 
				'where' : {
					'FareBasis': JSON.stringify(farebasisConditions)
				},
				'Hid': hid,
			});
		}else{
			console.log('查询hotcity id 错误');
		}
	})

	// 


}

setCommand(eterm.createCommand(eterm.eterm,tpl));

// 所有的计划任务
function mkTable(array, target, wrap, type){

	'use strict';

	if(!array) return;

	let html = '', 
			appendType = type !== ""? type : 'w',
	  	context = wrap !== "" ? wrap : document;

	// 暴露至全局
	cabin = array[0].HC_Cabin.split(',');

	html +=`
		  <table class="${target} table table-hover table-bordered table-responsive">
		  <thead>
				<tr>
					<th>序号</th>
					<th>出发</th>
					<th>到达</th>
					<th>航路</th>
					<th>航空公司</th>
					<th>目标舱位</th>
					<th>计划来源</th>
					<th>运价状态</th>
					<th>舱位状态</th>
					<th>状态</th>
					<th>创建时间</th>
					<th>更新时间</th>
					<th>操作</th>
				</tr>
			</thead>
	`
	for(var i in array){
		var query = JSON.parse(array[i].HC_Query);
		html +=`
				<tr>
					<td>${i}</td>
					<td>${array[i].HC_Depart}</td>
					<td>${array[i].HC_Arrive}</td>
					<td>${array[i].HC_Routing}</td>
					<td>${array[i].HC_Aircompany}</td>
					<td>${array[i].HC_Cabin}</td>
					<td>航空公司：${query? query['aircompany'] : ""} | 出发：${query? query['depart'] : ''} | 区域：${query? query['region'] : ''} | 规则：${query? query['rule']: ''}</td>
					<td>`
		html +=	array[i].HC_XfsdResult_Status == 2 ? `<a href="javascript:void(0)" class="xfsd-result" data-sid="${array[i].HC_XfsdResult_Sid}">全部</a> | <a href="javascript:void(0)" class="simplify-xfsd" data-sid="${array[i].HC_XfsdResult_Sid}">精简</a> `: '等待'
		html +=`</td>
					<td>`
		html += array[i].HC_AvhResult_Status == 2? `<a href="javascript:void(0)" class="avh-result" data-sid="${array[i].HC_AvhResult_Sid}">查看</a>`: '等待'
		html +=`</td>
					<td>${array[i].HC_Status == 2? '完成': '等待'}</td>
					<td>${new Date((array[i].GmtCreate -0)*1000).format("yyyy-MM-dd hh:mm:ss")}</td>
					<td>${new Date((array[i].GmtModified -0)*1000).format("yyyy-MM-dd hh:mm:ss")}</td>
					<td><a href='javascript:void(0)' class='mix-cabin' data-id="${array[i].Id}" data-xfsdsid="${array[i].HC_XfsdResult_Sid}" data-avhsid="${array[i].HC_AvhResult_Sid}" data-hotcity='${JSON.stringify(array[i])}'>混舱</a></td>
				</tr>
		`
	}

	html += '</table>';

	appendType === 'a'? $(context).append(html): $(context).html(html);
}

// xfsd 运价模板
function xfsdTable(array, dom){
	let html = `<div class='${dom}'>`;
	for(var j in array){
		html += `<table class="table table-hover table-bordered table-responsive">
					<tr>
						<th>序号</th>
						<th>fare</th>
						<th>命令</th>
						<th>提前出票</th>
						<th>单程价格</th>
						<th>往返价格</th>
						<th>舱位</th>
						<th>最短停留</th>
						<th>最长停留</th>
						<th>适用截止日期</th>
						<th>退票规则</th>
						<th>可用星期</th>
						<th>出发</th>
						<th>到达</th>
						<th>航空公司</th>
						<th>方向</th>
						<th>创建日期</th>
					</tr>`
		var value ;
		for(var i in array[j]){
			value = array[j][i];
			html += `
				<tr>
						<td>${i}</td>
						<td>${value['FareBasis']}</td>
						<td>${value['Command']}</td>
						<td>${value['xfsd_Advp']}</td>
						<td>${value['xfsd_SingleFee']}</td>
						<td>${value['xfsd_RoundFee']}</td>
						<td>${value['xfsd_Cabin']}</td>
						<td>${value['xfsd_MinStay']}</td>
						<td>${value['xfsd_MaxStay']}</td>
						<td>${value['xfsd_DateStart']}>${value['xfsd_DateEnd']}</td>
						<td>${value['xfsd_Rule']}</td>
						<td>${value['xfsd_Indicator']}</td>
						<td>${value['xfsd_Dep']}</td>
						<td>${value['xfsd_Arr']}</td>
						<td>${value['xfsd_Owner']}</td>
						<td>${value['xfsd_Region']}</td>
						<td>${new Date((value['gmtCreate'] -0)*1000).format("yyyy-MM-dd hh:mm:ss")}</td>
				</tr>
			`
		}
	}
	html += "</div>";
	return html;
}

// avh 舱位模板
function avhTpl(array, dom){ // (data, className, container)
	// 暴露至全局
	avh = array.result;

	let html = "<table class='${dom} table table-hover table-bordered table-responsive'>";
	for( var i in array ){ 
			var avhCabin = eval('['+array[i].avh_Cabin+']')[0];
						
			html += "<tr>";
			html += `
				<td>${i}</td>
				<td>${array[i].avh_Flight}</td>
				<td>${array[i].avh_Dep}</td>
				<td>${array[i].avh_Arr}</td>
				<td>${array[i].avh_DepTime}-${array[i].avh_ArrTime}<!--${array[i].avh_FlightTime}--></td>
				<td>
			`
			// 显示特定舱位
			if(cabin[0] != '' && cabin.length > 0){
				for(var s in cabin){
					if( avhCabin[cabin[s]] ){ // 屏蔽掉无舱位数据
						if( avhCabin[cabin[s]] -0 >3){
							html += "<span style='color:red'>"+cabin[s]+'('+avhCabin[cabin[s]]+")</span>/";
						}else{
							html += cabin[s]+'('+avhCabin[cabin[s]]+")/";
						}
					}
				}
			}
			// 未设置特定舱位
			else{
				for(var s in avhCabin){
					if(avhCabin[s]-0 >3){
						html += "<span style='color:red'>"+s+'('+avhCabin[s]+")</span>/";
					}else{
						html += s+'('+avhCabin[s]+")/";
					}
				}
			}
			html += "</td>";
			html += `<td>${new Date((array[i].gmtModified -0)*1000).format("yyyy-MM-dd hh:mm:ss")}</td>`;
			html += "</tr>";
	}
	html += '</table>';

	$('#modal-content').html(html);
	avhModal.show();
}


// 混舱1：回填销售日期
function mkSaleDateInsertTableFromPrice(array){
	let html = '', saleDate = '';
	html += `<table class="table table-hover table-bordered table-responsive">
		<thead>
			<tr>
				<th>FareBasis</th>
				<th>命令</th>
				<th>销售日期</th>
			</tr>
		</thead>
	`;

	for(var i in array){
		saleDate = array[i].SaleDate ? array[i].SaleDate: '';
		html += `
			<tr>
				<td>${array[i].FareBasis}</td>
				<td>XS/FSD${array[i].Dep}${array[i].Arr}//${array[i].Airline}/#*${array[i].FareBasis}/${array[i].Rule.replace(' ', '')}//# -> XS FSN1//15（销售限制）, XS FSN1//4（航班限制）</td>
				<td><input type='text' class='form-control saleDate' data-rule="${array[i].Rule}" value="${saleDate}" placeholder='格式：XXXX-XX-XX>XXXX-XX-XX，输入一条'></td>
			</tr>
		`
	}
	return html;
}

// 混舱1.2：测试farebasis可用 isTest = true
// 混舱1.3：回填使政策可用的信息
// 混舱2：混舱
function mixCabin(data, hotcity, isTest){
	if(JSON.stringify(data) === '{}') return;
	// 将分组的统一为非分组的
	var array = [];
	for(var a in data){
		array = array.concat(data[a])
	}

	// 内积 a^2
	var result     = [],                        // 最终混舱结果
			stayArray  = hotcity['HC_Routing'].split(','),       // 全部的中转城市
			cabinMatch = hotcity['HC_Cabin'].split(','), // 热门城市舱位对照
			date       = new Date();                  // 时间对象

	function maxDate(date1, date2){
		if(/\d/.exec(date1) && /\d/.exec(date2)){
			return /\d/.exec(date1)[0]*(/D/.exec(date1)?1:30) > /\d/.exec(date2)[0]*(/D/.exec(date2)?1:30) ? date1 : date2;
		}
		else 
			return '';
	}

	function makeArrayData(outboundData, inboundData, stay){
		// 过滤不合法的混舱数据
		// 适用日期不合理
		var outboundDataBegin = new Date(outboundData['ValidBegin']), 
				outboundDataEnd   = new Date(outboundData['ValidEnd']),
				inboundDataBegin  = new Date(inboundData['ValidBegin']),
				inboundDataEnd    = new Date(inboundData['ValidEnd']); 

		if(outboundDataEnd < inboundDataBegin || outboundDataBegin > inboundDataEnd ) return;

		if(outboundData.SaleDate || inboundData.SaleDate){
			// 多个销售日期
			// 销售日期不合理过滤
			var outboundSaleDateBegin = outboundData['SaleDate'].split('>')[0],
					outboundSaleDateEnd   = outboundData['SaleDate'].split('>')[1],
					inboundSaleDateBegin  = inboundData['SaleDate'].split('>')[0],
					inboundSaleDateEnd    = inboundData['SaleDate'].split('>')[1];

			if(outboundSaleDateEnd < inboundSaleDateBegin || outboundSaleDateBegin > inboundSaleDateEnd ) return;
			var SaleDateBegin = date.max(outboundSaleDateBegin, inboundSaleDateBegin),
					SaleDateEnd   = date.max(outboundSaleDateEnd, inboundSaleDateEnd);
		}

		var flight = '';
		if(outboundData['Flight'] != '' && inboundData['Flight'] != '') {
			if(outboundData['Flight'] !== inboundData['Flight']){
				flight = outboundData['Flight']+','+inboundData['Flight'];
			}else{
				flight = outboundData['Flight']
			}
		}else if(outboundData['Flight'] != ''){
			flight = outboundData['Flight']
		}else if(inboundData['Flight'] != ''){
			flight = inboundData['Flight']
		}


		var result = {
				'FareBasis'     : outboundData['FareBasis']+'/'+inboundData['FareBasis'],
				'Advp'          : maxDate(outboundData['Advp'], inboundData['Advp']),
				'SingleFare'    : outboundData['SingleFare']-0 == 0 ? 0:(outboundData['SingleFare']-0)/2+(inboundData['SingleFare']-0)/2,
				'RoundFare'     : outboundData['RoundFare']-0 == 0 ? 0:(outboundData['RoundFare']-0)/2+(inboundData['RoundFare']-0)/2,
				'SaleDate'      : SaleDateBegin ? SaleDateBegin+'>'+SaleDateEnd:'',
				'Flight'        : flight,
				// 出境的舱位，和境外的舱位存在争议
				'Cabin'         : outboundData['Cabin']+(stay ? '-'+outboundData['Cabin']+'-'+inboundData['Cabin']:'')+'-'+inboundData['Cabin'],
				'MinStop'       : maxDate(outboundData['MinStop'], inboundData['MinStop']),
				'MaxStop'       : maxDate(outboundData['MaxStop'], inboundData['MaxStop']),
				'ValidBegin'    : date.max(outboundData['ValidBegin'], inboundData['ValidBegin']),
				'ValidEnd'      : date.max(outboundData['ValidEnd'], inboundData['ValidEnd']),
				'OutboundWeek'  : outboundData['OutboundWeek'],
				'InboundWeek'   : inboundData['OutboundWeek'],
				'Rule'          : outboundData['Rule']+'/'+inboundData['Rule'],
				'Dep'           : outboundData['Dep'],
				'Arr'           : outboundData['Arr'],
				// 新增字段：中转城市
				'Stay'          : stay ? stay : '', 
				'Airline'       : outboundData['Airline'],
				// 新增字段：航路
				'Routing'      : {},
				// 新增字段：fsi
				// XS FSI/UA
	      // S UA   1310\09SEP BJS0100 0200CHI0X    76W 
	      // S UA   1310\09SEP CHI0300 0400NYC0S    76W 
	      // S UA   981\09SEP BJS0100 0200CHI0X    76W
	      // S UA   981\09SEP NYC0300 0400BJS0S    76W 
				'Fsi'           : {}
			}
			var outboundDate   = outboundData['FareDate'],
					outboundFlight = '0000',
					inboundDate    = inboundData['FareDate'],
					inboundFlight  = '0000';
			if(stay){
				result['Routing'] = {
					'allStay' : outboundData['Dep']+'-'+outboundData['Airline']+'-'+stay+'-'+outboundData['Airline']+'-'+outboundData['Arr']+'-'+inboundData['Airline']+'-'+stay+'-'+inboundData['Airline']+'-'+inboundData['Dep'],
					'outboundStay' : outboundData['Dep']+'-'+outboundData['Airline']+'-'+stay+'-'+outboundData['Airline']+'-'+outboundData['Arr']+'-'+inboundData['Airline']+'-'+inboundData['Dep'],
					'inboundStay' : outboundData['Dep']+'-'+outboundData['Airline']+'-'+outboundData['Arr']+'-'+inboundData['Airline']+'-'+stay+'-'+inboundData['Airline']+'-'+inboundData['Dep'],
					'noStay': outboundData['Dep']+'-'+outboundData['Airline']+'-'+outboundData['Arr']+'-'+inboundData['Airline']+'-'+inboundData['Dep'],
				}
				result['Fsi'] = {
					'allStay' :  "XS FSI/"+outboundData['Airline']+"\r"
						+ "S "+outboundData['Airline']+"   "+outboundFlight+outboundData['Cabin']+outboundDate+" "+outboundData['Dep']+"0100 0200"+stay+"0X    76W \r" 
						+ "S "+outboundData['Airline']+"   "+outboundFlight+outboundData['Cabin']+outboundDate+" "+stay+"0300 0400"+outboundData['Arr']+"0S    76W \r"
						+ "S "+inboundData['Airline'] +"   "+inboundFlight +inboundData['Cabin'] +inboundDate +" "+inboundData['Arr']+"0500 0600"+stay+"0X    76W \r" 
						+ "S "+inboundData['Airline'] +"   "+inboundFlight +inboundData['Cabin'] +inboundDate +" "+stay+"0700 0800"+inboundData['Dep']+"0S    76W \r",
					'outboundStay' : "XS FSI/"+outboundData['Airline']+"\r"
						+ "S "+outboundData['Airline']+"   "+outboundFlight+outboundData['Cabin']+outboundDate+" "+outboundData['Dep']+"0100 0200"+stay+"0X    76W \r" 
						+ "S "+outboundData['Airline']+"   "+outboundFlight+outboundData['Cabin']+outboundDate+" "+stay+"0300 0400"+outboundData['Arr']+"0S    76W \r"
						+ "S "+inboundData['Airline'] +"   "+inboundFlight +inboundData['Cabin'] +inboundDate +" "+inboundData['Arr']+"0700 0800"+inboundData['Dep']+"0S    76W \r",
					'inboundStay'  : "XS FSI/"+outboundData['Airline']+"\r"
						+ "S "+outboundData['Airline']+"   "+outboundFlight+outboundData['Cabin']+outboundDate+" "+outboundData['Dep']+"0300 0400"+outboundData['Arr']+"0S    76W \r"
						+ "S "+inboundData['Airline'] +"   "+inboundFlight +inboundData['Cabin'] +inboundDate +" "+inboundData['Arr']+"0500 0600"+stay+"0X    76W \r" 
						+ "S "+inboundData['Airline'] +"   "+inboundFlight +inboundData['Cabin'] +inboundDate +" "+stay+"0700 0800"+inboundData['Dep']+"0S    76W \r",
					'noStay': "XS FSI/"+outboundData['Airline']+"\r"
						+ "S "+outboundData['Airline']+"   "+outboundFlight+outboundData['Cabin']+outboundDate+" "+outboundData['Dep']+"0100 0200"+outboundData['Arr']+"0S    76W \r" 
						+ "S "+inboundData['Airline'] +"   "+inboundFlight +inboundData['Cabin'] +inboundDate +" "+inboundData['Arr']+"0300 0400"+inboundData['Dep']+"0S    76W \r" 
				}
			}else{
				result['Routing'] = {
					'noStay': outboundData['Dep']+'-'+outboundData['Airline']+'-'+outboundData['Arr']+'-'+inboundData['Airline']+'-'+inboundData['Dep']
				}
				result['Fsi'] = {
					'noStay': "XS FSI/"+outboundData['Airline']+"\r"
						+ "S "+outboundData['Airline']+"   "+outboundFlight+outboundData['Cabin']+outboundData['FareDate']+" "+outboundData['Dep']+"0100 0200"+outboundData['Arr']+"0S    76W \r" 
						+ "S "+inboundData['Airline'] +"   "+inboundFlight +inboundData['Cabin'] +inboundData['FareDate'] +" "+inboundData['Arr']+"0300 0400"+inboundData['Dep']+"0S    76W \r" 
				}
			}
			return result;
	}

	// 根据热门城市筛选舱位
	if(cabinMatch.length > 1 && cabinMatch[0] != '')
		for(var a in array){
			for(var c in cabinMatch){
				if(cabinMatch[c] === array[a].Cabin)
					break;
				if(c === cabinMatch.length-1)
					array[a].splice(a, 1);
			}
		}

	var makeArrayDataResult;

	if(isTest){
		// 仅匹配相同fare，不包含中转
		for(var o in array){
  		makeArrayDataResult = makeArrayData(array[o], array[o])
			if(makeArrayDataResult){
				result.push(makeArrayDataResult)
			}
		}
		return result
	}

	for(var i in array){   // 去程
		for(var j in array){ // 回程
      if(stayArray.length > 0 && stayArray[0] != ''){
				for(var s in stayArray){ // 中转点
					// 按照中转再次拆分
					makeArrayDataResult = makeArrayData(array[i], array[j], stayArray[s])
					if(makeArrayDataResult){
						result.push(makeArrayDataResult)
					}
				}
      }else{
      		makeArrayDataResult = makeArrayData(array[i], array[j])
					if(makeArrayDataResult){
						result.push(makeArrayDataResult)
					}
      }
		}
	}
	return result;
}

function mkMixCabinTable(data){

	if(data.length === 0 ) return;
	// 处理数据
	for(var i in data){
		data[i].index     = i-0+1;
 		data[i].ValidDate = data[i].ValidBegin+'>'+data[i].ValidEnd;
	}
	// 生成列
	var columns = [];
	var title = {
		'index'        : '序号',
		'FareBasis'    : 'FareBasis',
		'Advp'         : '提前出票',
		'RoundFare'    : '往返价格',
		'Cabin'        : '舱位',
		'MinStop'      : '最小停留',
		'MaxStop'      : '最长停留',
		'ValidDate'    : '适用日期',
		'Rule'         : '规则',
		'Dep'          : '出发',
		'Arr'          : '到达',
		'OutboundWeek' : '可用星期',
		'Airline'      : '航空公司',
		'SaleDate'     : '销售日期',
		// 'Fsi'          : 'Fsi', 
		// 'Routing'     : '航路',
	}

	for(var c in title){
		columns.push({
      "data" : c,  
      "title" : title[c],  
		})
	}
	columns.push(
	// Fsi
	{
		data: null,
		title: 'Fsi'
	},
	// input: 航班限制 Flight
	{
		data: null,
		title: '航班限制'
	})

	// Routing
	// columns.push({
	// 	data: null,
	// 	title: '航路'
	// })

	$('#otherModal #modal-content').html('<table id="mixCabinTable" class="table table-hover table-bordered table-responsive" width="2000px"></table>')
	$('#mixCabinTable').DataTable({
    // responsive: true,
    scrollX: true,
    iDisplayLength: 100,
    data: data,
    columns : columns,
	  columnDefs: [{
        targets: 14, // Fsi
        render: function(data, type, row, meta) {
        	var html = "<textarea rows='3' cols='50' class='form-control' disabled>"
        	for(var i in data.Fsi){
        		html += data.Fsi[i]+"\r------------------------------\r"
        	}
        	html += '</textarea>'
          return html
        }
    },
    {
        targets: 15, // 航班限制
        render: function(data, type, row, meta) {
        	// farebasis一致
        	var html = "<input type='text' class='input-flight form-control' value='"+row.Flight+"' data-farebasis='"+row.FareBasis.split('/')[0]+"' onblur='upper(this)' placeholder='当运价与fsi结果不一致'>";
          return html
        }
    },
    // {
    //     targets: 14, // Routing
    //     render: function(data, type, row, meta) {
    //     	var html = ''
    //     	for(var i in data.Routing){
    //     		html += ""+data.Routing[i]+"<br>------------------------------<br>"
    //     	}
    //       return html
    //     }
    // }
    ]      
	})
}
// --------------------  过期方法 ---------------------
function xfsdTpl(array, dom, show){

	// 暴露至全局
	xfsd_src = array;

	show = show ? true: false;
	let html = "<div class='${dom}'>";
	for(var i in array){
		html += `<table class="table table-hover table-bordered table-responsive">
					<tr>
						<th>序号</th>
						<th>fare</th>
						<th>命令</th>
						<th>提前出票</th>
						<th>单程价格</th>
						<th>往返价格</th>
						<th>舱位</th>
						<th>最短停留</th>
						<th>最长停留</th>
						<th>适用截止日期</th>
						<th>退票规则</th>
						<th>可用星期</th>
						<th>出发</th>
						<th>到达</th>
						<th>航空公司</th>
						<th>方向</th>
						<th>创建日期</th>
					</tr>`
		for(var j in array[i].result){
			var value = array[i]['result'][j];
			html += `
				<tr>
						<td>${j}</td>
						<td>${value['FareBasis']}</td>
						<td>${value['Command']}</td>
						<td>${value['xfsd_Advp']}</td>
						<td>${value['xfsd_SingleFee']}</td>
						<td>${value['xfsd_RoundFee']}</td>
						<td>${value['xfsd_Cabin']}</td>
						<td>${value['xfsd_MinStay']}</td>
						<td>${value['xfsd_MaxStay']}</td>
						<td>${value['xfsd_DateStart']}>${value['xfsd_DateEnd']}</td>
						<td>${value['xfsd_Rule']}</td>
						<td>${value['xfsd_Indicator']}</td>
						<td>${value['xfsd_Dep']}</td>
						<td>${value['xfsd_Arr']}</td>
						<td>${value['xfsd_Owner']}</td>
						<td>${value['xfsd_Region']}</td>
						<td>${new Date((value['gmtCreate'] -0)*1000).format("yyyy-MM-dd hh:mm:ss")}</td>
				</tr>
			`
		}
	}
	html += "</div>";

	if(show){
		$('#modal-content').html(html);
		xfsdModal.show();
	}
}


})

</script>

<{/block}>