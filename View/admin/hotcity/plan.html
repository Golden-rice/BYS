<{extends file='../layout.html'}>

<{block name="title"}>计划任务<{/block}>
<{block name="content"}>

<div id="content"></div>

<!-- other modal -->
<div class="modal fade" id="otherModal" tabindex="-1" role="dialog" aria-labelledby="modalLabel" >
  <div class="modal-dialog modal-lg" role="document" style='width:1600px'>
    <div class="modal-content">

      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="modalLabel"> </h4>
      </div>
      <!-- modal header -->

      <div class="modal-body">
        <div id="modal-content"></div>
      </div>
      <!-- modal body -->

      <div class="modal-footer">
        <button type="button" class="btn btn-default hidden" data-dismiss="modal">关闭</button>
      </div>
      <!-- modal footer -->

    </div>
  </div>
</div>
<!-- other modal end -->

<div id="model-wrap-1"></div>

<script>
require(['eterm', 'dt'], function (eterm, dt){

// 弹出框   
var OtherModel = function(title, content, footer){

    $("#otherModal .modal-title").html(title);
    $("#otherModal #modal-content").html(content);
    $("#otherModal .modal-footer").html(footer ? footer:`<button type="button" class="btn btn-default hidden"  data-dismiss="modal">关闭</button>`);

    return {
        hide: function(){
        	$("#example").modal('hide');
        },
        show: function(){
            $("#otherModal").modal();
        },
        set: function(title, contetn, footer){
			    $("#otherModal .modal-title").html(title);
			    $("#otherModal #modal-content").html(content);
			    $("#otherModal .modal-footer").html(footer);
        }
    }
}

var tpl = {
	mkTable: mkTable,
	avhTpl: avhTpl,
}

// 弹出层 暴露至全局
var avhModal, mixModal;

var cabin = [];    // 全局变量：目标舱位

function uniqueXfsd(result){
	if(!result || result.length == 0) {
		return;
	}
	// 过滤重复舱位，保存最便宜的
	var tmpCabin = result[0].xfsd_Cabin,      // 临时舱位
			tmpXfsd = {},                         // 临时xfsd
			array = [];                           // 最后返回结果

	tmpXfsd[result[0].xfsd_Cabin] = result[0];  // 初始化

	// 去重
	for (var i in result){
		if(tmpCabin !== result[i].xfsd_Cabin && tmpXfsd[result[i].xfsd_Cabin] == undefined ){
			tmpXfsd[result[i].xfsd_Cabin] = result[i]
			tmpCabin = result[i].xfsd_Cabin;
		}
	}

	for (var j in tmpXfsd){
		array.push(tmpXfsd[j])
	}
	return array;
}

var setCommand = function(command){

	command.showHotCityPlan();
	// 全局变量
	var xfsdInGroup;    // xfsd 分组的全部数据
	var xfsdSmpInGroup; // xfsd 分组的全部数据
	var	hid;            // 当前混舱的hotcity id 
	var hotcity;        // 热门城市数据

	// 汇率
	if(!eterm.eterm.rate){
		command.rate();
	}

	// 查询全部且分组的 xfsd
	var searchXfsdResultByHotcity = new command.ReqCommand({
		url: eterm.const.Controller + 'searchXfsdResultByHotcity',
		clk: function(res){
			if(res.msg)
				alert(res.msg)

			if(res.status){
				xfsdInGroup    = res.inGroupResult
				xfsdSmpInGroup = res.inGroupSmpResult
				
				var	allFareModal = new OtherModel("运价结果", xfsdTable(xfsdInGroup, 'xfsd-result-model'));
					allFareModal.show();
			}
		}
	}) 


	// 查询精简且分组的 xfsd
	var searchSmpXfsdResultByHotcity = new command.ReqCommand({
		url: eterm.const.Controller + 'searchXfsdResultByHotcity',
		clk: function(res){
			if(res.msg)
				alert(res.msg)

			if(res.status){
				xfsdSmpInGroup = res.inGroupSmpResult
				xfsdInGroup    = res.inGroupResult
				var	smpModal   = new OtherModel("精简运价结果", xfsdTable(xfsdSmpInGroup, 'xfsd-result-model'));
				smpModal.show();
			}
		}
	}) 

	// 更新基础政策
	var updatePriceSource = new command.ReqCommand({
		url: eterm.const.Controller + 'updatePriceSourceByAll',
		clk: function(res){
			console.log(res)
			if(res.msg)
				console.log(res.msg)
		}
	})


	// 更新基础政策：是否经过检验
	var updatePriceSourceIsCheck = new command.ReqCommand({
		url: eterm.const.Controller + 'updatePriceSourceByOne',
		clk: function(res){
			if(res.msg)
				// alert(res.msg)

			if(res.status){
				console.log(res)
			}
		}
	}) 
 
	// 根据测试数据回填规则
	var setPriceSourcePolicy = new command.ReqCommand({
		url: eterm.const.Controller + 'searchPriceSource',
		clk: function(res){

			if(res.msg)
				alert(res.msg)

			if(res.status){
				setPriceSourcePolicy.data = res.result;

				var model = new command.OtherModel(
					"回填政策并检验",
					mkMixCabinTable(command.mixCabinFromHotcity(res.result, hotcity, true)), 
					`<button type="button" class="btn btn-default" id='set-SaleDate' >销售日期</button>
					 <button type="button" class="btn btn-default" id='set-Flight'>航班限制</button>
					 <button type="button" class="btn btn-primary" id='save-rewrite' data-dismiss="modal">保存</button>`
				);
				// setTimeout(function(){
				model.show();
				// },500)
			}
		}
	}) 


	// res 返回的结果， updateRely 更新的依据（ID，stay）
	function parseCheckRes(res, updateRely, name){
		// ES6 
		"use strict";
		console.log(res, updateRely);
		// 找到存放更新信息的容器
		let [id, wapper] = [updateRely.id, $("#check-"+name+"-1")]; 

		// 成功结果
		if(res.status){

			if(res.priceDetail.allPrice){

				// 返回的详细总价  具体运价
				let [totalPrice, priceDetail, tooltipTitle] = [0, res.priceDetail, '']; 
				priceDetail.farebasisPrice.map(i=>totalPrice += i.price-0);

				// 取整
				totalPrice = command.mkFarePrice( totalPrice, eterm.eterm.rate);
				// 实际运价与混舱价格相等
				if( totalPrice === command.mkFarePrice( updateRely.price, eterm.eterm.rate)){

					priceDetail.farebasisPrice.map(i=>tooltipTitle += "&nbsp;"+i.farebasis+"&nbsp;|&nbsp;"+i.leg+"&nbsp;|&nbsp;"+i.price+"&nbsp;\r");

					wapper.html('验证成功'+' <a class="tooltip-option" href="javascript:void(0)" data-toggle="tooltip" title="'+tooltipTitle+'" data-placement="left"><i class="fa fa-tag"></i></a>').next('input').val(1);

					// 更新数据库
					updatePriceSourceIsCheck.execute({
						'update': { 'IsCheck': 1, 'CheckDetail': JSON.stringify({'farebasisPrice': priceDetail.farebasisPrice, 'allPrice': priceDetail.allPrice}) }, 
						'where' : { 'Id' :  updateRely.id, },
						'Hid'   : hid,
					});
					$('.tooltip-option').tooltip({ html: true });
				}
				// 实际运价与混舱价格不相等
				else{
					console.log('价格不一致', totalPrice, res.price, command.mkFarePrice( updateRely.price, eterm.eterm.rate), updateRely.price)
				}
			}else{
				// 无详细价格，仅用qte 的价格 与 混舱的价格比较
				console.log('无详细的QTE价格', priceDetail)
			}
		}
		// 失败结果
		else{
			alert(res.msg);
			wapper.html('<a href="javascript:void(0)" class="check-failed-click">隐藏</a>').closest('tr').after('<tr class="check-failed-tr"><td colspan=16><textarea class="form-control"  rows="16" style="background-color:black;color:green;">'+res.log+'</textarea></td></tr>');
			updatePriceSourceIsCheck.execute({
				'update': { 'IsCheck': -1 }, 
				'where' : { 'Id' :  id, },
				'Hid'   : hid,
			});
		}
	}

	// 检查fsi
	var checkfsi = new command.ReqCommand({
		url: eterm.const.Controller + 'checkfsi',
		clk: function(res){
			console.log(res)
			var src = checkfsi.returnConfig().query;
			var $data = $('#'+src.id).next('input');
			if(res.msg){
				alert(res.msg);
				$('#'+src.id).html('<a href="javascript:void(0)" class="check-failed-click">隐藏</a>').closest('tr').after('<tr class="check-failed-tr"><td colspan=16><textarea class="form-control"  rows="16" style="background-color:black;color:green;">'+res.log+'</textarea></td></tr>')
			
					updatePriceSourceIsCheck.execute({
						'update': {
							'IsCheck': -1
						}, 
						'where' : {
							'Stay': $data.data('stay'),
							'Id' :  $data.data('id'),
						},
						'Hid': hid,
					});
			}

			if(res.status){
				var totalPrice = 0;
				var priceDetail = res.priceDetail;
				for(var i in priceDetail.farebasisPrice){
					totalPrice += priceDetail.farebasisPrice[i].price - 0;
				}
				// 判断价格是否一致，防止有附加值 totalPrice 替换 res.price 
				totalPrice = command.mkFarePrice( totalPrice, eterm.eterm.rate)
				if( totalPrice == command.mkFarePrice( src.price, eterm.eterm.rate)){
					var tooltipTitle = '';
					for(var i in priceDetail.farebasisPrice){
						tooltipTitle += "&nbsp;"+priceDetail.farebasisPrice[i].farebasis+"&nbsp;|&nbsp;"+priceDetail.farebasisPrice[i].leg+"&nbsp;|&nbsp;"+priceDetail.farebasisPrice[i].price+"&nbsp;\r"
					}

					$('#'+src.id).html('验证成功'+' <a class="tooltip-option" href="javascript:void(0)" data-toggle="tooltip" title="'+tooltipTitle+'" data-placement="left"><i class="fa fa-tag"></i></a>').next('input').val(1);


					// 更新数据库
					updatePriceSourceIsCheck.execute({
						'update': {
							'IsCheck': 1,
							'CheckDetail': JSON.stringify(priceDetail)
						}, 
						'where' : {
							'Stay': $data.data('stay'),
							'Id' :  $data.data('id'),
						},
						'Hid': hid,
					});
					$('.tooltip-option').tooltip({ html: true });
				}else{
					console.log('价格不一致', totalPrice, res.price, command.mkFarePrice( src.price, eterm.eterm.rate), src.price)
				}
			}
		}
	}) 

	var checkqte = new command.ReqCommand({
		url: eterm.const.Controller + 'checkqte',
		clk: function(res){
			if(res.status) // 成功返回结果
				parseCheckRes(res, checkqte.returnConfig().query, 'qte')
			else // 返回的结果出错误了
				alert(res.msg)
		}
	})

	// 查看 xfsd
	$("#content").on("click", ".xfsd-result", function(){
		var sid = $(this).data('sid')+"", sidArray = sid.split(','), has = false;
		if(xfsdInGroup){ 
			for(var i in sidArray){
				if(xfsdInGroup[sidArray[i]]) {
					has = true;
					break;
				}
			}
			if(has){
				mixModal  = new OtherModel("运价结果", xfsdTable(xfsdInGroup, 'xfsd-result-model'));
				mixModal.show();
			}else{
				searchSmpXfsdResultByHotcity.execute({'sid': sid});
			}
		}else{
			searchXfsdResultByHotcity.execute({'sid': sid});
		}
	})

	// 查看 avh
	$("#content").on("click", ".avh-result", function(){
		avhModal  = new OtherModel("舱位结果", '');
		command.searchAvhResult({'sid': $(this).data('sid')});
	})

	// 查看 简化结果
	$("#content").on("click", ".simplify-xfsd", function(){
		var sid = $(this).data('sid')+"", sidArray = sid.split(','), has = false;

		if(xfsdSmpInGroup){ 

			for(var i in sidArray){
				if(xfsdSmpInGroup[sidArray[i]]) {
					has = true;
					break;
				}
			}
			if(has){
				mixModal  = new OtherModel("精简运价结果", xfsdTable(xfsdSmpInGroup, 'xfsd-result-model'));
				mixModal.show();
			}else{
				searchSmpXfsdResultByHotcity.execute({'sid': sid});
			}
		}else{
			searchSmpXfsdResultByHotcity.execute({'sid': sid});
		}
	})

	// 混舱 xfsd 
	$("#content").on('click', '.mix-cabin', function(){
		// 全局点击的标识
		hid     = $(this).data('id');
		// 获得hotcity数据
		hotcity = $(this).data('hotcity');
		// 弹出回填政策
		setPriceSourcePolicy.execute({'hid': hid});
	})

	// 销售日期
	setPolicyColFunction('SaleDate', 'Rule', distingRule)
	// 航班限制
	setPolicyColFunction('Flight', 'FareBasis')
	
	// 保存回填信息
	$('#otherModal').on('click', '#save-rewrite', function(){
		if(hid != undefined){
			console.log(setPriceSourcePolicy.data)
			var updates = [];
			for(var i in setPriceSourcePolicy.data){
				updates.push({
					'value': {
						'Flight': setPriceSourcePolicy.data[i].Flight,
						'SaleDate': setPriceSourcePolicy.data[i].SaleDate,
					},
					'where': {
						'Id': setPriceSourcePolicy.data[i].Id
					}
				})
			}
			updatePriceSource.execute({'updates': JSON.stringify(updates)});
		}else{
			console.log('查询hotcity id 错误');
		}
	})

	// 检查fsi
	$('#otherModal').on('click', '.check-fsi', function(){
		checkfsi.execute({
			'fsi': $(this).data('fsi'), 
			'id': $(this).closest('span').attr('id'), 
			'price': $(this).data('price')
		})
	})

	// 隐藏 fsi返回的结果
	$('#otherModal').on('click', '.check-failed-click', function(){
		var $fsi_failed_tr = $(this).closest('tr').next('tr');
		if($fsi_failed_tr.css('display') === 'none'){
			$fsi_failed_tr.show();
			$(this).text('隐藏')
		}else{
			$fsi_failed_tr.hide();
			$(this).text('显示')
		}
	})

	// 查看无适用运价的fsi
	$('#otherModal').on('click', '.look-fsi', function(){
		command.mkOtherModel('otherModel-2', "", '#model-wrap')
		var model = new command.OtherModel('fsi', '<textarea class="form-control"  rows="16" style="background-color:black;color:green;">'+$(this).data('fsi')+'</textarea>', '', 'otherModel-2');
		model.show();
	})

	// 检查qte
	$('#otherModal').on('click', '.check-qte', function(){

		var data = $(this).data('qte')

		checkqte.execute({
			'start': data.start, 
			'end': data.end, 
			'stay': data.stay, 
			'aircompany': data.aircompany, 
			'cabin': data.cabin, 
			'price': $(this).data('price'), 
			'id': $(this).data('id')
		})

	})

	// colName 更新属性名（一个）, whereName 更新条件名（一个）,clk展示回填面板的数据处理函数, fn 对回填结果的处理函数，mk${colName}InsertTableFromPrice 默认使用的展示回填面板函数
	function setPolicyColFunction(colName, whereName, clk, fn){
		$('#otherModal').on('click', '#set-'+colName, function(){
			var a,
					source   = setPriceSourcePolicy.data, 
					renderFn = 'mk'+colName+'InsertTableFromPrice'; 

			if(!(renderFn && renderFn in command)){
				console.log('展示回填面板函数不存在', command)
				return;
			} 

			// 回填colName
			if(clk && eterm.eterm.isFunction(clk)) source = clk(source)
			a = new command.OtherModel(
				"回填销售日期", 
				command[renderFn](source), 
				`<button type="button" class="btn btn-primary" data-dismiss="modal" id="save-${colName}">保存</button>`,
				'otherModal-2','medium', "#model-wrap-1");
			a.show();
		})

		// 保存回填的colName
		$('#model-wrap-1').on('click', '#save-'+colName, function(){
			// 生成新数据
			if(hid != undefined){
				var updata = [], updataObj = {},
						where = [], whereObj  = {}, 
						data;

				$('.'+colName).each(function(){
					where.push($(this).data(whereName.toLowerCase()));
					updata.push($(this).val());
				})

				// by colunm name, where, updata, source
				updataObj[colName]  = updata;
				whereObj[whereName] = where;
				data = updateDataBy(whereObj, updataObj, setPriceSourcePolicy.data);
			}else{
				console.log('查询hotcity id 错误');
			}

			if(fn && eterm.eterm.isFunction(fn)) data = fn(data)
		  data = command.mixCabinFromHotcity(setPriceSourcePolicy.data, hotcity, true)

			// 清空 model content，并回填新数据
			$('#otherModal #modal-content').html(mkMixCabinTable(data));
			
		})
	}
	

	// 混舱1.1：回填销售日期
	command.mkSaleDateInsertTableFromPrice = function(array){
		let html = '', saleDate = '';
		html += `<table class="table table-hover table-bordered table-responsive">
			<thead>
				<tr>
					<th>FareBasis</th>
					<th>命令</th>
					<th>销售日期</th>
				</tr>
			</thead>
		`;

		for(var i in array){
			html += `
				<tr>
					<td>${array[i].FareBasis}</td>
					<td>XS/FSD${array[i].Dep}${array[i].Arr}//${array[i].Airline}/#*${array[i].FareBasis}/// -> XS FSN1//15（销售限制）</td> 
					<!-- XS/FSD${array[i].Dep}${array[i].Arr}//${array[i].Airline}/#*${array[i].FareBasis}/// -> XS FSN1//15（销售限制）, XS FSN1//4（航班限制） -->
					<td><input type='text' class='form-control SaleDate' style='width:350px' data-Rule="${array[i].Rule}" value="${array[i].SaleDate}" placeholder='XXXX-XX-XX>XXXX-XX-XX，输入一条'></td>
				</tr>
			`
		}
		return html;
	}

	// 混舱1.2：回填航班限制
	command.mkFlightInsertTableFromPrice = function(array){
		let html = '', flight = '';
		html += `<table class="table table-hover table-bordered table-responsive">
			<thead>
				<tr>
					<th>FareBasis</th>
					<th>舱位</th>
					<th>中转城市</th>
					<th>命令</th>
					<th>航班限制</th>
				</tr>
			</thead>
		`;
		console.log(array)
		for(var i in array){
			html += `
				<tr>
					<td>${array[i].FareBasis}</td>
					<td>${array[i].Cabin}</td>
					<td>${array[i].Stay}</td>
					<td>XS/FSD${array[i].Dep}${array[i].Arr}//${array[i].Airline}/#*${array[i].FareBasis}/// ->  XS FSN1//4（航班限制）</td> 
					<td><input type='text' class='form-control Flight' value="${array[i].Flight}" placeholder='格式：' data-Farebasis='${array[i].FareBasis}'></td>
				</tr>
			`
		}
		return html;
	}

	// 区分Rule
	function distingRule(array){
		var rule = {}, result = [];
		for(var i in array){
			if(!rule[array[i].Rule]){
				rule[array[i].Rule] = 1;
				result.push(array[i]);
			}
		}
		return result;
	}

	// 更新 source 
	function updateDataBy(where, updata, source){
		if(!source.length) {
			console.log('数据源不存在')
			return;
		}

		// 目前仅支持一个条件
		for(var o in where){
			var wKey = o;
			break;
		}

		// 目前仅支持一个更新
		for(var p in updata){
			var pKey = p;
			break;
		}

		for(var i in source){
			if(source[i][wKey] !== undefined && source[i][pKey] !== undefined){
				for(var k in where[wKey]){
					// 条件相等时
					if(source[i][wKey] == where[wKey][k] && source[i].Hid == hid){
						source[i][pKey] = updata[pKey][k];
					}
				}
			}else{
				console.log('查询的条件在源数据中没有')
				break;
			}
		}
		return source;
	}


}

setCommand(eterm.createCommand(eterm.eterm,tpl));

// 所有的计划任务
function mkTable(array, target, wrap, type){

	'use strict';

	if(!array) return;

	let html = '', 
			appendType = type !== ""? type : 'w',
	  	context = wrap !== "" ? wrap : document;

	// 暴露至全局
	cabin = array[0].HC_Cabin.split(',');

	html +=`
		  <table class="${target} table table-hover table-bordered table-responsive">
		  <thead>
				<tr>
					<th>序号</th>
					<th>出发</th>
					<th>到达</th>
					<th>航路</th>
					<th>航空公司</th>
					<th>目标舱位</th>
					<!-- <th>计划来源</th> -->
					<th>运价状态</th>
					<th>舱位状态</th>
					<th>状态</th>
					<th>创建时间</th>
					<th>更新时间</th>
					<th>操作</th>
				</tr>
			</thead>
	`
	for(var i in array){
		var query = JSON.parse(array[i].HC_Query);
		html +=`
				<tr>
					<td>${i}</td>
					<td>${array[i].HC_Depart}</td>
					<td>${array[i].HC_Arrive}</td>
					<td>${array[i].HC_Routing}</td>
					<td>${array[i].HC_Aircompany}</td>
					<td>${array[i].HC_Cabin}</td>
					<!-- <td>航空公司：${query? query['aircompany'] : ""} | 出发：${query? query['depart'] : ''} | 区域：${query? query['region'] : ''} | 规则：${query? query['rule']: ''}</td>-->
					<td> `
		html +=	array[i].HC_XfsdResult_Status == 2 ? `<a href="javascript:void(0)" class="xfsd-result" data-sid="${array[i].HC_XfsdResult_Sid}">全部</a> | <a href="javascript:void(0)" class="simplify-xfsd" data-sid="${array[i].HC_XfsdResult_Sid}">精简</a> `: '等待'
		html +=`</td>
					<td>`
		html += array[i].HC_AvhResult_Status == 2? `<a href="javascript:void(0)" class="avh-result" data-sid="${array[i].HC_AvhResult_Sid}">查看</a>`: '等待'
		html +=`</td>
					<td>${array[i].HC_Status == 2? '完成': '等待'}</td>
					<td>${new Date((array[i].GmtCreate -0)*1000).format("yyyy-MM-dd hh:mm:ss")}</td>
					<td>${new Date((array[i].GmtModified -0)*1000).format("yyyy-MM-dd hh:mm:ss")}</td>
					<td><a href='javascript:void(0)' class='mix-cabin' data-id="${array[i].Id}" data-xfsdsid="${array[i].HC_XfsdResult_Sid}" data-avhsid="${array[i].HC_AvhResult_Sid}" data-hotcity='${JSON.stringify(array[i])}'>混舱</a></td>
				</tr>
		`
	}

	html += '</table>';

	appendType === 'a'? $(context).append(html): $(context).html(html);
}

// xfsd 运价模板
function xfsdTable(array, dom){
	let html = `<div class='${dom}'>`;
	for(var j in array){
		html += `<table class="table table-hover table-bordered table-responsive">
					<tr>
						<th>序号</th>
						<th>fare</th>
						<th>命令</th>
						<th>提前出票</th>
						<th>单程价格</th>
						<th>往返价格</th>
						<th>舱位</th>
						<th>最短停留</th>
						<th>最长停留</th>
						<th>适用截止日期</th>
						<th>退票规则</th>
						<th>可用星期</th>
						<th>出发</th>
						<th>到达</th>
						<th>航空公司</th>
						<th>方向</th>
						<th>创建日期</th>
					</tr>`
		var value ;
		for(var i in array[j]){
			value = array[j][i];
			html += `
				<tr>
						<td>${i}</td>
						<td>${value['FareBasis']}</td>
						<td>${value['Command']}</td>
						<td>${value['xfsd_Advp']}</td>
						<td>${value['xfsd_SingleFee']}</td>
						<td>${value['xfsd_RoundFee']}</td>
						<td>${value['xfsd_Cabin']}</td>
						<td>${value['xfsd_MinStay']}</td>
						<td>${value['xfsd_MaxStay']}</td>
						<td>${value['xfsd_DateStart']}>${value['xfsd_DateEnd']}</td>
						<td>${value['xfsd_Rule']}</td>
						<td>${value['xfsd_Indicator']}</td>
						<td>${value['xfsd_Dep']}</td>
						<td>${value['xfsd_Arr']}</td>
						<td>${value['xfsd_Owner']}</td>
						<td>${value['xfsd_Region']}</td>
						<td>${new Date((value['gmtCreate'] -0)*1000).format("yyyy-MM-dd hh:mm:ss")}</td>
				</tr>
			`
		}
	}
	html += "</div>";
	return html;
}

// avh 舱位模板
function avhTpl(array, dom){
	// 暴露至全局
	avh = array.result;

	let html = "<table class='${dom} table table-hover table-bordered table-responsive'>";
	for( var i in array ){ 
			var avhCabin = eval('['+array[i].avh_Cabin+']')[0];
						
			html += "<tr>";
			html += `
				<td>${i}</td>
				<td>${array[i].avh_Flight}</td>
				<td>${array[i].avh_Dep}</td>
				<td>${array[i].avh_Arr}</td>
				<td>${array[i].avh_DepTime}-${array[i].avh_ArrTime}<!--${array[i].avh_FlightTime}--></td>
				<td>
			`
			// 显示特定舱位
			if(cabin[0] != '' && cabin.length > 0){
				for(var s in cabin){
					if( avhCabin[cabin[s]] ){ // 屏蔽掉无舱位数据
						if( avhCabin[cabin[s]] -0 >3){
							html += "<span style='color:red'>"+cabin[s]+'('+avhCabin[cabin[s]]+")</span>/";
						}else{
							html += cabin[s]+'('+avhCabin[cabin[s]]+")/";
						}
					}
				}
			}
			// 未设置特定舱位
			else{
				for(var s in avhCabin){
					if(avhCabin[s]-0 >3){
						html += "<span style='color:red'>"+s+'('+avhCabin[s]+")</span>/";
					}else{
						html += s+'('+avhCabin[s]+")/";
					}
				}
			}
			html += "</td>";
			html += `<td>${new Date((array[i].gmtModified -0)*1000).format("yyyy-MM-dd hh:mm:ss")}</td>`;
			html += "</tr>";
	}
	html += '</table>';

	$('#modal-content').html(html);
	avhModal.show();
}

// 混舱2：混舱
function mkMixCabinTable(data){

	if(data.length === 0 ) return;
	// 处理数据
	for(var i in data){
		data[i].index     = i-0+1;
 		data[i].ValidDate = data[i].ValidBegin+'>'+data[i].ValidEnd;
	}
	// 生成列
	var columns = [];
	var title = {
		'index'        : '序号',
		'FareBasis'    : 'FareBasis',
		'Advp'         : '提前出票',
		'RoundFare'    : '往返价格',
		'Cabin'        : '舱位',
		'MinStop'      : '最小停留',
		'MaxStop'      : '最长停留',
		'ValidDate'    : '适用日期',
		'Rule'         : '规则',
		'Dep'          : '出发',
		'Arr'          : '到达',
		'OutboundWeek' : '可用星期',
		'Airline'      : '航空公司',
		'SaleDate'     : '销售日期',
		// 'Fsi'         : 'Fsi', 
		// 'Routing'     : '航路',
	}

	for(var c in title){
		columns.push({
      "data" : c,  
      "title" : title[c],  
		})
	}
	columns.push(
		// Routing
		{
			data: null,
			title: '航路'
		},
		// input: 航班限制 Flight
		{
			data: null,
			title: '航班限制'
		},
		// Fsi
		{
			data: null,
			title: 'Fsi'
		},
		// QTE
		{
			data: null,
			title: 'QTE'
		}
	)

	// Routing
	// columns.push({
	// 	data: null,
	// 	title: '航路'
	// })

	$('#otherModal #modal-content').html('<div style="overflow-x:scroll;"><table id="mixCabinTable" class="table table-hover table-bordered table-responsive" width="2000px"></table></div>')
	$('#mixCabinTable').DataTable({
    // responsive: true,
    // scrollX: true,
    iDisplayLength: 100,
    data: data,
    columns : columns,
	  columnDefs: [
    {
        targets: 14, // 航路
        render: function(data, type, row, meta) {
          return row.Routing.allStay ? row.Routing.allStay : row.Routing.noStay;
        }
    },
    {
        targets: 15, // 航班限制
        render: function(data, type, row, meta) {
        	// farebasis一致
        	// var html = "<input type='text' class='input-flight form-control' value='"+row.Flight+"' data-farebasis='"+row.FareBasis.split('/')[0]+"' onblur='upper(this)' placeholder='当运价与fsi结果不一致'>";
        	var html = row.Flight;
          return html
        }
    },
		{
        targets: 16, // Fsi
        render: function(data, type, row, meta) {
        	// fsi 命令
        	// var html = "<textarea rows='3' cols='50' class='form-control' disabled>"
        	// for(var i in data.Fsi){
        	// 	html += data.Fsi[i]+"\r------------------------------\r"
        	// }
        	// html += '</textarea>'

        	// 检验按钮
        	if(row.IsCheck == 1){
        		var tooltipTitle = '';
        		if(row.CheckDetail){
        			var checkDetail = JSON.parse(row.CheckDetail)
							for(var i in checkDetail.farebasisPrice){
								tooltipTitle += "&nbsp;"+checkDetail.farebasisPrice[i].farebasis+"&nbsp;|&nbsp;"+checkDetail.farebasisPrice[i].leg+"&nbsp;|&nbsp;"+checkDetail.farebasisPrice[i].price+"&nbsp;\r"
							}
        		}

        		var html = '验证成功' + '&nbsp;<a class="tooltip-option" href="javascript:void(0)" data-toggle="tooltip" title="'+tooltipTitle+'" data-placement="left"><i class="fa fa-tag"></i></a>'
        	}else if(row.IsCheck == -1){
	        	var html = '指定的票价不符合运价规则' ; // + '&nbsp;<a class="look-fsi" href="javascript:void(0)" data-fsi="'+row.Fsi.allStay+'">查看fsi</a>'
        	}else{
	        	var html = '<span id="fsi-'+row.index+'""><a href="javascript:void(0)" class="check-fsi" data-fsi='+JSON.stringify(data.Fsi.allStay ? data.Fsi.allStay : data.Fsi.noStay)+' data-price="'+row.RoundFare+'">验证</a></span><input type="hidden" class="input-IsCheck" data-stay='+row.Stay+' data-id='+row.Id+'>'
        	}

          return html
        }
    },{
        targets: 17, // QTE
        render: function(data, type, row, meta) {
        	if(row.IsCheck == 1){
        		var tooltipTitle = '';
        		if(row.CheckDetail){
        			var checkDetail = JSON.parse(row.CheckDetail)
							for(var i in checkDetail.farebasisPrice){
								tooltipTitle += "&nbsp;"+checkDetail.farebasisPrice[i].farebasis+"&nbsp;|&nbsp;"+checkDetail.farebasisPrice[i].leg+"&nbsp;|&nbsp;"+checkDetail.farebasisPrice[i].price+"&nbsp;\r"
							}
        		}

        		var html = '验证成功' + '&nbsp;<a class="tooltip-option" href="javascript:void(0)" data-toggle="tooltip" title="'+tooltipTitle+'" data-placement="left"><i class="fa fa-tag"></i></a>'
        	}else if(row.IsCheck == -1){
	        	var html = '指定的票价不符合运价规则' ; // + '&nbsp;<a class="look-fsi" href="javascript:void(0)" data-fsi="'+row.Fsi.allStay+'">查看fsi</a>'
        	}else{
	        	var html = '<span id="qte-'+row.index+'""><a href="javascript:void(0)" class="check-qte" data-qte='+JSON.stringify({start: row.Dep, end: row.Arr, aircompany: row.Airline, stay: row.Stay, cabin: row.Cabin.split('-')[0]})+' data-price="'+row.RoundFare+'" data-id='+row.Id+'>验证</a></span><input type="hidden" class="input-IsCheck" data-stay='+row.Stay+' data-id='+row.Id+'>'
	        }
          return html;
        }
    }
    ]      
	})

	$('.tooltip-option').tooltip({
    html: true
 	});
}



// --------------------  过期方法 ---------------------


})

</script>

<{/block}>