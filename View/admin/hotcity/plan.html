<{extends file='../layout.html'}>

<{block name="title"}>计划任务<{/block}>
<{block name="content"}>

<div id="content"></div>
<!-- other modal -->
<div class="modal fade" id="otherModal" tabindex="-1" role="dialog" aria-labelledby="modalLabel" >
  <div class="modal-dialog modal-lg" role="document" style='width:1600px'>
    <div class="modal-content">

      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="modalLabel"> </h4>
      </div>
      <!-- modal header -->

      <div class="modal-body">
        <div id="modal-content">
            

        </div>
      </div>
      <!-- modal body -->

      <div class="modal-footer">
        <button type="button" class="btn btn-default hidden" data-dismiss="modal">关闭</button>
      </div>
      <!-- modal footer -->

    </div>
  </div>
</div>
<!-- other modal end -->

<script>
require(['eterm', 'dt'], function (eterm, dt){

// 弹出框   
var OtherModel = function(title, content, footer){

    $("#otherModal .modal-title").html(title);
    $("#otherModal #modal-content").html(content);
    $("#otherModal .modal-footer").html(footer ? footer:`<button type="button" class="btn btn-default hidden"  data-dismiss="modal">关闭</button>`);

    return {
        hide: function(){
        	$("#example").modal('hide');
        },
        show: function(){
            $("#otherModal").modal();
        },
        set: function(title, contetn, footer){
			    $("#otherModal .modal-title").html(title);
			    $("#otherModal #modal-content").html(content);
			    $("#otherModal .modal-footer").html(footer);
        }
    }
}

var tpl = {
	mkTable: mkTable,
	xfsdTpl: xfsdTpl,
	avhTpl: avhTpl,
}

// 弹出层 暴露至全局
var xfsdModal, avhModal, mixModal;

var cabin = [];    // 全局变量：目标舱位
		// xfsd_src,   // 全局变量：xfsd 原始数据
		// avh;        // 全局变量：avh

function uniqueXfsd(result){
	if(!result || result.length == 0) {
		return;
	}
	// 过滤重复舱位，保存最便宜的
	var tmpCabin = result[0].xfsd_Cabin,      // 临时舱位
			tmpXfsd = {},                         // 临时xfsd
			array = [];                           // 最后返回结果

	tmpXfsd[result[0].xfsd_Cabin] = result[0];  // 初始化

	// 去重
	for (var i in result){
		if(tmpCabin !== result[i].xfsd_Cabin && tmpXfsd[result[i].xfsd_Cabin] == undefined ){
			tmpXfsd[result[i].xfsd_Cabin] = result[i]
			tmpCabin = result[i].xfsd_Cabin;
		}
	}

	for (var j in tmpXfsd){
		array.push(tmpXfsd[j])
	}
	return array;
}

var setCommand = function(command){

	command.showHotCityPlan();
	// 全局变量
	var xfsdInGroup;    // xfsd 分组的全部数据
	var xfsdSmpInGroup; // xfsd 分组的全部数据
	var	hid;            // 当前混舱的hotcity id 
	var hotcity;        // 热门城市数据

	// 汇率
	if(!eterm.eterm.rate){
		command.rate();
	}

	// 查询全部且分组的 xfsd
	var searchXfsdResultByHotcity = new command.ReqCommand({
		url: eterm.const.Controller + 'searchXfsdResultByHotcity',
		clk: function(res){
			if(res.msg)
				alert(res.msg)

			if(res.status){
				xfsdInGroup    = res.inGroupResult
				xfsdSmpInGroup = res.inGroupSmpResult
				
				var	allFareModal = new OtherModel("运价结果", xfsdTable(xfsdInGroup, 'xfsd-result-model'));
					allFareModal.show();
				
			}
		}
	}) 


	// 查询精简且分组的 xfsd
	var searchSmpXfsdResultByHotcity = new command.ReqCommand({
		url: eterm.const.Controller + 'searchXfsdResultByHotcity',
		clk: function(res){
			if(res.msg)
				alert(res.msg)

			if(res.status){
				// var inGroupSmpResult = [];
				// xfsdInGroup = res.inGroupResult
				// for(var i in res.inGroupResult){
				// 	inGroupSmpResult.push(uniqueXfsd(res.inGroupResult[i]))
				// }

				xfsdSmpInGroup = res.inGroupSmpResult
				xfsdInGroup    = res.inGroupResult
				
				var	smpModal   = new OtherModel("精简运价结果", xfsdTable(xfsdSmpInGroup, 'xfsd-result-model'));
					smpModal.show();
				
			}
		}
	}) 


	// 查询政策基础数据规则
	var reqPriceSourceRule = new command.ReqCommand({
		url: eterm.const.Controller + 'searchPriceSourceRule',
		clk: function(res){
			if(res.status){
				var a = new OtherModel("回填销售日期", mkSaleDateInsertTableFromPrice(res.result), `<button type="button" class="btn btn-primary" data-dismiss="modal" id='set-saleDate'>保存销售日期，并下一步</button><button type="button" class="btn btn-default hidden"  data-dismiss="modal">关闭</button>`);
				a.show();
			}
				
			if(res.msg)
				alert(res.msg);
		}
	}) 

	// 更新基础政策：销售日期
	var updatePriceSourceSaleDate = new command.ReqCommand({
		url: eterm.const.Controller + 'updatePriceSource',
		clk: function(res){
			if(res.msg)
				console.log(res.msg)
				// alert(res.msg)

			if(res.status){
				// mixModal.hide();
				setPriceSourceFlight.execute({'hid': hid})
			}
		}
	}) 

	// 更新基础政策：航班限制
	var updatePriceSourceFlight = new command.ReqCommand({
		url: eterm.const.Controller + 'updatePriceSource',
		clk: function(res){
			if(res.msg)
				console.log(res.msg)
				// alert(res.msg)

			if(res.status){
				// mixModal.hide();
				// searchPriceSource.execute({'hid': hid});
				// selectMixCabinTpl.execute({});
				window.open(eterm.const.Controller + 'mixcabin?hid='+hid)
			}
		}
	}) 

	var updatePriceSourceIsCheck = new command.ReqCommand({
		url: eterm.const.Controller + 'updatePriceSource',
		clk: function(res){
			if(res.msg)
				// alert(res.msg)

			if(res.status){
				console.log(res)
			}
		}
	}) 

	// 选择混舱模板
	var selectMixCabinTpl = new command.ReqCommand({
		url: eterm.const.Controller + 'selectMixCabinTpl',
		clk: function(res){
			if(res.msg)
				alert(res.msg)

			if(res.status){
				console.log(res)
			}
		}
	}) 

	// 查询price source
	// var searchPriceSource = new command.ReqCommand({
	// 	url: eterm.const.Controller + 'searchPriceSource',
	// 	clk: function(res){
	// 		if(res.msg)
	// 			alert(res.msg)

	// 		if(res.status){
	// 			var ValidResult = command.mixCabinFromHotcity(res.result, hotcity);
	// 			console.log(res, ValidResult)
	// 			var c  = new OtherModel("混舱数据", mkMixCabinTable(ValidResult));
	// 			setTimeout(function(){
	// 				c.show();
	// 			},500)
	// 		}
	// 	}
	// }) 

	// 查询price source
	var setPriceSourceFlight = new command.ReqCommand({
		url: eterm.const.Controller + 'searchPriceSource',
		clk: function(res){
			if(res.msg)
				alert(res.msg)

			if(res.status){
				var testValidResult = command.mixCabinFromHotcity(res.result, hotcity, true)
				var b = new OtherModel("混舱测试数据", mkMixCabinTable(testValidResult), `<button type="button" class="btn btn-primary" id='set-flight' data-dismiss="modal">保存航班限制，并下一步</button><button type="button" class="btn btn-default"  data-dismiss="modal">关闭</button>`);
				setTimeout(function(){
					b.show();
				},500)
			}
		}
	}) 

	// 检查fsi
	var checkfsi = new command.ReqCommand({
		url: eterm.const.Controller + 'checkfsi',
		clk: function(res){

			if(res.msg)
				alert(res.msg)

			if(res.status){
				console.log(res)
				var src = checkfsi.returnConfig().query;
				var totalPrice = 0;
				var priceDetail = res.priceDetail;
				for(var i in priceDetail.farebasisPrice){
					totalPrice += priceDetail.farebasisPrice[i].price - 0;
				}
				// 判断价格是否一致，防止有附加值 totalPrice 替换 res.price 
				totalPrice = command.mkFarePrice( totalPrice, eterm.eterm.rate)
				if( totalPrice == command.mkFarePrice( src.price, eterm.eterm.rate)){
					var tooltipTitle = '<table>';
					for(var i in priceDetail.farebasisPrice){
						// tooltipTitle += "<tr><td>&nbsp;"+priceDetail.farebasisPrice[i].farebasis+"&nbsp;</td><td>&nbsp;"+priceDetail.farebasisPrice[i].leg+"&nbsp;</td><td>&nbsp;"+priceDetail.farebasisPrice[i].price+"&nbsp;</td></tr>"
						tooltipTitle += "&nbsp;"+priceDetail.farebasisPrice[i].farebasis+"&nbsp;|&nbsp;"+priceDetail.farebasisPrice[i].leg+"&nbsp;|&nbsp;"+priceDetail.farebasisPrice[i].price+"&nbsp;\r"
					}
					tooltipTitle += "</table>"
					$('#'+src.id).html('验证成功'+' <a class="tooltip-option" href="javascript:void(0)" data-toggle="tooltip" title="'+tooltipTitle+'" data-placement="left"><i class="fa fa-tag"></i></a>').next('input').val(1);
					updatePriceSourceIsCheck.execute({
						'update': {
							'IsCheck': JSON.stringify([1])
						}, 
						'where' : {
							'Stay': JSON.stringify([$('#'+src.id).next('input').data('stay')])
						},
						'Hid': hid,
					});
					$('.tooltip-option').tooltip({
            html: true
         	});
				}else{
					console.log('价格不一致', totalPrice, res.price, command.mkFarePrice( src.price, eterm.eterm.rate), src.price)
				}
			}
		}
	}) 


	// 查看 xfsd
	$("#content").on("click", ".xfsd-result", function(){
		// xfsdModal = new OtherModel("运价结果", '');
		// command.searchXfsdResult({sid: $(this).data('sid')});
		var sid = $(this).data('sid')+"", sidArray = sid.split(','), has = false;
		if(xfsdInGroup){ 
			for(var i in sidArray){
				if(xfsdInGroup[sidArray[i]]) {
					has = true;
					break;
				}
			}
			if(has){
				mixModal  = new OtherModel("运价结果", xfsdTable(xfsdInGroup, 'xfsd-result-model'));
				mixModal.show();
			}else{
				searchSmpXfsdResultByHotcity.execute({'sid': sid});
			}
		}else{
			searchXfsdResultByHotcity.execute({'sid': sid});
		}
	})

	// 查看 avh
	$("#content").on("click", ".avh-result", function(){
		avhModal  = new OtherModel("舱位结果", '');
		command.searchAvhResult({'sid': $(this).data('sid')});
	})

	// 查看 简化结果
	$("#content").on("click", ".simplify-xfsd", function(){
		// xfsdModal = new OtherModel("精简运价结果", '');
		// command.searchXfsdResultByHotcity({sid: $(this).data('sid')})
		var sid = $(this).data('sid')+"", sidArray = sid.split(','), has = false;

		if(xfsdSmpInGroup){ 

			for(var i in sidArray){
				if(xfsdSmpInGroup[sidArray[i]]) {
					has = true;
					break;
				}
			}
			if(has){
				mixModal  = new OtherModel("精简运价结果", xfsdTable(xfsdSmpInGroup, 'xfsd-result-model'));
				mixModal.show();
			}else{
				searchSmpXfsdResultByHotcity.execute({'sid': sid});
			}
		}else{
			searchSmpXfsdResultByHotcity.execute({'sid': sid});
		}
	})

	// // 混舱 xfsd 临时
	// $("#content").on('click', '.mix-cabin', function(){
	// 	// 暴露全局变量
	// 	// 销售日期更新
	// 	hid     = $(this).data('id');
	// 	// 获得hotcity数据
	// 	hotcity = $(this).data('hotcity');

	// 	searchPriceSource.execute({'hid': hid})

	// })
	

	// 混舱 xfsd 
	$("#content").on('click', '.mix-cabin', function(){
		// 暴露全局变量
		// 销售日期更新
		hid     = $(this).data('id');
		// 获得hotcity数据
		hotcity = $(this).data('hotcity');

		reqPriceSourceRule.execute({'hid': hid});

	})

	// 销售日期的【下一步】
	$('#otherModal').on('click', '#set-saleDate', function(){
		// 更新
		if(hid != undefined){
			var saleDateInput = [];
			var ruleConditions = [];
			$('.saleDate').each(function(){
				ruleConditions.push($(this).data('rule'));
				saleDateInput.push($(this).val());
			})
			updatePriceSourceSaleDate.execute({
				'update': {
					'SaleDate': JSON.stringify(saleDateInput)
				}, 
				'where' : {
					'Rule': JSON.stringify(ruleConditions)
				},
				'Hid': hid,
			});

		}else{
			console.log('查询hotcity id 错误');
		}
	})

	// 混舱fsi测试的【下一步】
	$('#otherModal').on('click', '#set-flight', function(){
		// 更新
		if(hid != undefined){
			var flightInput = [];          // 航班限制
			var farebasisConditions = [];
			$('.input-flight').each(function(){
				farebasisConditions.push($(this).data('farebasis'))
				flightInput.push($(this).val())
			})
			updatePriceSourceFlight.execute({
				'update': {
					'Flight': JSON.stringify(flightInput)
				}, 
				'where' : {
					'FareBasis': JSON.stringify(farebasisConditions)
				},
				'Hid': hid,
			});

		}else{
			console.log('查询hotcity id 错误');
		}
	})

	// 检查fsi
	$('#otherModal').on('click', '.check-fsi', function(){
		checkfsi.execute({fsi: $(this).data('fsi'), id: $(this).closest('span').attr('id'), price: $(this).data('price')})
	})

}

setCommand(eterm.createCommand(eterm.eterm,tpl));

// 所有的计划任务
function mkTable(array, target, wrap, type){

	'use strict';

	if(!array) return;

	let html = '', 
			appendType = type !== ""? type : 'w',
	  	context = wrap !== "" ? wrap : document;

	// 暴露至全局
	cabin = array[0].HC_Cabin.split(',');

	html +=`
		  <table class="${target} table table-hover table-bordered table-responsive">
		  <thead>
				<tr>
					<th>序号</th>
					<th>出发</th>
					<th>到达</th>
					<th>航路</th>
					<th>航空公司</th>
					<th>目标舱位</th>
					<!-- <th>计划来源</th> -->
					<th>运价状态</th>
					<th>舱位状态</th>
					<th>状态</th>
					<th>创建时间</th>
					<th>更新时间</th>
					<th>操作</th>
				</tr>
			</thead>
	`
	for(var i in array){
		var query = JSON.parse(array[i].HC_Query);
		html +=`
				<tr>
					<td>${i}</td>
					<td>${array[i].HC_Depart}</td>
					<td>${array[i].HC_Arrive}</td>
					<td>${array[i].HC_Routing}</td>
					<td>${array[i].HC_Aircompany}</td>
					<td>${array[i].HC_Cabin}</td>
					<!-- <td>航空公司：${query? query['aircompany'] : ""} | 出发：${query? query['depart'] : ''} | 区域：${query? query['region'] : ''} | 规则：${query? query['rule']: ''}</td>-->
					<td> `
		html +=	array[i].HC_XfsdResult_Status == 2 ? `<a href="javascript:void(0)" class="xfsd-result" data-sid="${array[i].HC_XfsdResult_Sid}">全部</a> | <a href="javascript:void(0)" class="simplify-xfsd" data-sid="${array[i].HC_XfsdResult_Sid}">精简</a> `: '等待'
		html +=`</td>
					<td>`
		html += array[i].HC_AvhResult_Status == 2? `<a href="javascript:void(0)" class="avh-result" data-sid="${array[i].HC_AvhResult_Sid}">查看</a>`: '等待'
		html +=`</td>
					<td>${array[i].HC_Status == 2? '完成': '等待'}</td>
					<td>${new Date((array[i].GmtCreate -0)*1000).format("yyyy-MM-dd hh:mm:ss")}</td>
					<td>${new Date((array[i].GmtModified -0)*1000).format("yyyy-MM-dd hh:mm:ss")}</td>
					<td><a href='javascript:void(0)' class='mix-cabin' data-id="${array[i].Id}" data-xfsdsid="${array[i].HC_XfsdResult_Sid}" data-avhsid="${array[i].HC_AvhResult_Sid}" data-hotcity='${JSON.stringify(array[i])}'>混舱</a></td>
				</tr>
		`
	}

	html += '</table>';

	appendType === 'a'? $(context).append(html): $(context).html(html);
}

// xfsd 运价模板
function xfsdTable(array, dom){
	let html = `<div class='${dom}'>`;
	for(var j in array){
		html += `<table class="table table-hover table-bordered table-responsive">
					<tr>
						<th>序号</th>
						<th>fare</th>
						<th>命令</th>
						<th>提前出票</th>
						<th>单程价格</th>
						<th>往返价格</th>
						<th>舱位</th>
						<th>最短停留</th>
						<th>最长停留</th>
						<th>适用截止日期</th>
						<th>退票规则</th>
						<th>可用星期</th>
						<th>出发</th>
						<th>到达</th>
						<th>航空公司</th>
						<th>方向</th>
						<th>创建日期</th>
					</tr>`
		var value ;
		for(var i in array[j]){
			value = array[j][i];
			html += `
				<tr>
						<td>${i}</td>
						<td>${value['FareBasis']}</td>
						<td>${value['Command']}</td>
						<td>${value['xfsd_Advp']}</td>
						<td>${value['xfsd_SingleFee']}</td>
						<td>${value['xfsd_RoundFee']}</td>
						<td>${value['xfsd_Cabin']}</td>
						<td>${value['xfsd_MinStay']}</td>
						<td>${value['xfsd_MaxStay']}</td>
						<td>${value['xfsd_DateStart']}>${value['xfsd_DateEnd']}</td>
						<td>${value['xfsd_Rule']}</td>
						<td>${value['xfsd_Indicator']}</td>
						<td>${value['xfsd_Dep']}</td>
						<td>${value['xfsd_Arr']}</td>
						<td>${value['xfsd_Owner']}</td>
						<td>${value['xfsd_Region']}</td>
						<td>${new Date((value['gmtCreate'] -0)*1000).format("yyyy-MM-dd hh:mm:ss")}</td>
				</tr>
			`
		}
	}
	html += "</div>";
	return html;
}

// avh 舱位模板
function avhTpl(array, dom){ // (data, className, container)
	// 暴露至全局
	avh = array.result;

	let html = "<table class='${dom} table table-hover table-bordered table-responsive'>";
	for( var i in array ){ 
			var avhCabin = eval('['+array[i].avh_Cabin+']')[0];
						
			html += "<tr>";
			html += `
				<td>${i}</td>
				<td>${array[i].avh_Flight}</td>
				<td>${array[i].avh_Dep}</td>
				<td>${array[i].avh_Arr}</td>
				<td>${array[i].avh_DepTime}-${array[i].avh_ArrTime}<!--${array[i].avh_FlightTime}--></td>
				<td>
			`
			// 显示特定舱位
			if(cabin[0] != '' && cabin.length > 0){
				for(var s in cabin){
					if( avhCabin[cabin[s]] ){ // 屏蔽掉无舱位数据
						if( avhCabin[cabin[s]] -0 >3){
							html += "<span style='color:red'>"+cabin[s]+'('+avhCabin[cabin[s]]+")</span>/";
						}else{
							html += cabin[s]+'('+avhCabin[cabin[s]]+")/";
						}
					}
				}
			}
			// 未设置特定舱位
			else{
				for(var s in avhCabin){
					if(avhCabin[s]-0 >3){
						html += "<span style='color:red'>"+s+'('+avhCabin[s]+")</span>/";
					}else{
						html += s+'('+avhCabin[s]+")/";
					}
				}
			}
			html += "</td>";
			html += `<td>${new Date((array[i].gmtModified -0)*1000).format("yyyy-MM-dd hh:mm:ss")}</td>`;
			html += "</tr>";
	}
	html += '</table>';

	$('#modal-content').html(html);
	avhModal.show();
}


// 混舱1：回填销售日期
function mkSaleDateInsertTableFromPrice(array){
	let html = '', saleDate = '';
	html += `<table class="table table-hover table-bordered table-responsive">
		<thead>
			<tr>
				<th>FareBasis</th>
				<th>命令</th>
				<th>销售日期</th>
			</tr>
		</thead>
	`;

	for(var i in array){
		saleDate = array[i].SaleDate ? array[i].SaleDate: '';
		html += `
			<tr>
				<td>${array[i].FareBasis}</td>
				<td>XS/FSD${array[i].Dep}${array[i].Arr}//${array[i].Airline}/#*${array[i].FareBasis}/${array[i].Rule.replace(' ', '')}//# -> XS FSN1//15（销售限制）, XS FSN1//4（航班限制）</td>
				<td><input type='text' class='form-control saleDate' data-rule="${array[i].Rule}" value="${saleDate}" placeholder='格式：XXXX-XX-XX>XXXX-XX-XX，输入一条'></td>
			</tr>
		`
	}
	return html;
}

// 混舱1.2：测试farebasis可用 isTest = true
// 混舱1.3：回填使政策可用的信息
// 混舱2：混舱

function mkMixCabinTable(data){

	if(data.length === 0 ) return;
	// 处理数据
	for(var i in data){
		data[i].index     = i-0+1;
 		data[i].ValidDate = data[i].ValidBegin+'>'+data[i].ValidEnd;
	}
	// 生成列
	var columns = [];
	var title = {
		'index'        : '序号',
		'FareBasis'    : 'FareBasis',
		'Advp'         : '提前出票',
		'RoundFare'    : '往返价格',
		'Cabin'        : '舱位',
		'MinStop'      : '最小停留',
		'MaxStop'      : '最长停留',
		'ValidDate'    : '适用日期',
		'Rule'         : '规则',
		'Dep'          : '出发',
		'Arr'          : '到达',
		'OutboundWeek' : '可用星期',
		'Airline'      : '航空公司',
		'SaleDate'     : '销售日期',
		// 'Fsi'         : 'Fsi', 
		// 'Routing'     : '航路',
	}

	for(var c in title){
		columns.push({
      "data" : c,  
      "title" : title[c],  
		})
	}
	columns.push(
	// Routing
	{
		data: null,
		title: '航路'
	},
	// input: 航班限制 Flight
	{
		data: null,
		title: '航班限制'
	},
	// Fsi
	{
		data: null,
		title: 'Fsi'
	})

	// Routing
	// columns.push({
	// 	data: null,
	// 	title: '航路'
	// })

	$('#otherModal #modal-content').html('<table id="mixCabinTable" class="table table-hover table-bordered table-responsive" width="2000px"></table>')
	$('#mixCabinTable').DataTable({
    // responsive: true,
    scrollX: true,
    iDisplayLength: 100,
    data: data,
    columns : columns,
	  columnDefs: [{
        targets: 16, // Fsi
        render: function(data, type, row, meta) {
        	// fsi 命令
        	// var html = "<textarea rows='3' cols='50' class='form-control' disabled>"
        	// for(var i in data.Fsi){
        	// 	html += data.Fsi[i]+"\r------------------------------\r"
        	// }
        	// html += '</textarea>'

        	// 检验按钮
        	// if(row.IsCheck){
        	// 	var html = '验证成功'
        	// }else{
	        	var html = '<span  id="fsi-'+row.index+'""><a href="javascript:void(0)" class="check-fsi" data-fsi='+JSON.stringify(data.Fsi.allStay)+' data-price="'+row.RoundFare+'">验证</a></span><input type="hidden" class="input-IsCheck" data-stay='+row.Stay+' >'
        	// }


          return html
        }
    },
    {
        targets: 14, // 航路
        render: function(data, type, row, meta) {
          return row.Routing.allStay;
        }
    },
    {
        targets: 15, // 航班限制
        render: function(data, type, row, meta) {
        	// farebasis一致
        	var html = "<input type='text' class='input-flight form-control' value='"+row.Flight+"' data-farebasis='"+row.FareBasis.split('/')[0]+"' onblur='upper(this)' placeholder='当运价与fsi结果不一致'>";
          return html
        }
    },
    // {
    //     targets: 14, // Routing
    //     render: function(data, type, row, meta) {
    //     	var html = ''
    //     	for(var i in data.Routing){
    //     		html += ""+data.Routing[i]+"<br>------------------------------<br>"
    //     	}
    //       return html
    //     }
    // }
    ]      
	})


}
// --------------------  过期方法 ---------------------
function xfsdTpl(array, dom, show){

	// 暴露至全局
	xfsd_src = array;

	show = show ? true: false;
	let html = "<div class='${dom}'>";
	for(var i in array){
		html += `<table class="table table-hover table-bordered table-responsive">
					<tr>
						<th>序号</th>
						<th>fare</th>
						<th>命令</th>
						<th>提前出票</th>
						<th>单程价格</th>
						<th>往返价格</th>
						<th>舱位</th>
						<th>最短停留</th>
						<th>最长停留</th>
						<th>适用截止日期</th>
						<th>退票规则</th>
						<th>可用星期</th>
						<th>出发</th>
						<th>到达</th>
						<th>航空公司</th>
						<th>方向</th>
						<th>创建日期</th>
					</tr>`
		for(var j in array[i].result){
			var value = array[i]['result'][j];
			html += `
				<tr>
						<td>${j}</td>
						<td>${value['FareBasis']}</td>
						<td>${value['Command']}</td>
						<td>${value['xfsd_Advp']}</td>
						<td>${value['xfsd_SingleFee']}</td>
						<td>${value['xfsd_RoundFee']}</td>
						<td>${value['xfsd_Cabin']}</td>
						<td>${value['xfsd_MinStay']}</td>
						<td>${value['xfsd_MaxStay']}</td>
						<td>${value['xfsd_DateStart']}>${value['xfsd_DateEnd']}</td>
						<td>${value['xfsd_Rule']}</td>
						<td>${value['xfsd_Indicator']}</td>
						<td>${value['xfsd_Dep']}</td>
						<td>${value['xfsd_Arr']}</td>
						<td>${value['xfsd_Owner']}</td>
						<td>${value['xfsd_Region']}</td>
						<td>${new Date((value['gmtCreate'] -0)*1000).format("yyyy-MM-dd hh:mm:ss")}</td>
				</tr>
			`
		}
	}
	html += "</div>";

	if(show){
		$('#modal-content').html(html);
		xfsdModal.show();
	}
}


})

</script>

<{/block}>