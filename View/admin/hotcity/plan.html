<{extends file='../layout.html'}>

<{block name="title"}>计划任务<{/block}>
<{block name="content"}>

<div id="content"></div>
<!-- other modal -->
<div class="modal fade" id="otherModal" tabindex="-1" role="dialog" aria-labelledby="modalLabel" >
  <div class="modal-dialog modal-lg" role="document" style='width:1600px'>
    <div class="modal-content">

      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="modalLabel"> </h4>
      </div>
      <!-- modal header -->

      <div class="modal-body">
        <div id="modal-content">
            

        </div>
      </div>
      <!-- modal body -->

      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
      </div>
      <!-- modal footer -->

    </div>
  </div>
</div>
<!-- other modal end -->

<script>
require(['eterm', 'dt'], function (eterm, dt){

// 弹出框   
var OtherModel = function(title, content, footer){

    $("#otherModal .modal-title").html(title);
    $("#otherModal #modal-content").html(content);
    $("#otherModal .modal-footer").html(footer ? footer:`<button type="button" class="btn btn-default"  data-dismiss="modal">关闭</button>`);

    return {
        hide: function(){
            $("#otherModal").modal("hide");
        },
        show: function(){
            $("#otherModal").modal();
        },
        set: function(title, contetn, footer){
			    $("#otherModal .modal-title").html(title);
			    $("#otherModal #modal-content").html(content);
			    $("#otherModal .modal-footer").html(footer);
        }
    }
}

var tpl = {
	mkTable: mkTable,
	xfsdTpl: xfsdTpl,
	avhTpl: avhTpl,
}

// 弹出层 暴露至全局
var xfsdModal, avhModal, mixModal;

var cabin = []; // 全局变量：目标舱位
		// xfsd_src,   // 全局变量：xfsd 原始数据
		// avh;        // 全局变量：avh

function uniqueXfsd(result){
	if(!result || result.length == 0) {
		return;
	}
	// 过滤重复舱位，保存最便宜的
	var tmpCabin = result[0].xfsd_Cabin,      // 临时舱位
			tmpXfsd = {},                         // 临时xfsd
			array = [];                           // 最后返回结果

	tmpXfsd[result[0].xfsd_Cabin] = result[0];  // 初始化

	// 去重
	for (var i in result){
		if(tmpCabin !== result[i].xfsd_Cabin && tmpXfsd[result[i].xfsd_Cabin] == undefined ){
			tmpXfsd[result[i].xfsd_Cabin] = result[i]
			tmpCabin = result[i].xfsd_Cabin;
		}
	}

	for (var j in tmpXfsd){
		array.push(tmpXfsd[j])
	}
	return array;
}

function uniqueRule(result){
	if(!result || result.length == 0) {
		return;
	}
	// 过滤重复舱位，保存最便宜的
	var tmpRule = result[0].xfsd_Rule,      // 临时舱位
			tmpXfsd = {},                         // 临时xfsd
			array = [];                           // 最后返回结果

	tmpXfsd[result[0].xfsd_Rule] = result[0];  // 初始化

	// 去重
	for (var i in result){
		if(tmpRule !== result[i].xfsd_Rule && tmpRule[result[i].xfsd_Rule] == undefined ){
			tmpXfsd[result[i].xfsd_Rule] = result[i]
			tmpRule = result[i].xfsd_Rule;
		}
	}

	return tmpXfsd;
}

var setCommand = function(command){

	command.showHotCityPlan();
	// 全局变量
	var xfsdInGroup // xfsd 分组的全部数据

	// 查询全部且分组的 xfsd
	var searchXfsdResultByHotcity = new command.ReqCommand({
		url: eterm.const.Controller + 'searchXfsdResultByHotcity',
		clk: function(res){
			if(res.msg)
				alert(res.msg)

			if(res.status){
				xfsdInGroup = res.inGroupResult
				mixModal  = new OtherModel("运价结果", xfsdTable(xfsdInGroup, 'xfsd-result-model'));
				mixModal.show();
			}
		}
	}) 


	// 查询精简且分组的 xfsd
	var searchSmpXfsdResultByHotcity = new command.ReqCommand({
		url: eterm.const.Controller + 'searchXfsdResultByHotcity',
		clk: function(res){
			if(res.msg)
				alert(res.msg)

			if(res.status){
				var inGroupSmpResult = [];
				xfsdInGroup = res.inGroupResult
				for(var i in res.inGroupResult){
					inGroupSmpResult.push(uniqueXfsd(res.inGroupResult[i]))
				}
				mixModal  = new OtherModel("精简运价结果", xfsdTable(inGroupSmpResult, 'xfsd-result-model'));
				mixModal.show();
			}
		}
	}) 

	// 查询全部未分组的 xfsd
	var searchXfsdAllResultByHotcity = new command.ReqCommand({
		url: eterm.const.Controller + 'searchXfsdResultByHotcity',
		clk: function(res){
			if(res.msg)
				alert(res.msg)

			if(res.status){
				var allSmpResult = [], allSmpRule = []; // 未分组精简结果
				xfsdInGroup = res.inGroupResult
				for(var i in res.inGroupResult){
					allSmpResult = allSmpResult.concat(uniqueXfsd(res.inGroupResult[i]))
				}

				mixModal  = new OtherModel("回填销售日期", mkSaleDateInsertTable(uniqueRule(allSmpResult)), `<button type="button" class="btn btn-primary" id='set-saleDate'>下一步</button><button type="button" class="btn btn-default"  data-dismiss="modal">关闭</button>`);
				mixModal.show();
			}
		}
	}) 

	// 更新基础政策：销售日期
	var updatePriceSource = new command.ReqCommand({
		url: eterm.const.Controller + 'updatePriceSource',
		clk: function(res){
			if(res.msg)
				alert(res.msg)
			console.log(res)
			// if(res.status)
				// setSaleDateModel ? setSaleDateModel.hide() : updateSaleDateModel.hide();
		}
	}) 

	// 查看 xfsd
	$("#content").on("click", ".xfsd-result", function(){
		// xfsdModal = new OtherModel("运价结果", '');
		// command.searchXfsdResult({sid: $(this).data('sid')});
		if(xfsdInGroup){
			mixModal  = new OtherModel("运价结果", xfsdTable(xfsdInGroup, 'xfsd-result-model'));
			mixModal.show();
		}else{
			searchXfsdResultByHotcity.execute({sid: $(this).data('sid')});
		}
	})

	// 查看 avh
	$("#content").on("click", ".avh-result", function(){
		avhModal  = new OtherModel("舱位结果", '');
		command.searchAvhResult({sid: $(this).data('sid')});
	})

	// 查看 简化结果
	$("#content").on("click", ".simplify-xfsd", function(){
		// xfsdModal = new OtherModel("精简运价结果", '');
		// command.searchXfsdResultByHotcity({sid: $(this).data('sid')})
		
		if(xfsdInGroup){
			var inGroupSmpResult = [];
			for(var i in xfsdInGroup){
				inGroupSmpResult.push(uniqueXfsd(xfsdInGroup[i]))
			}
			mixModal  = new OtherModel("精简运价结果", xfsdTable(inGroupSmpResult, 'xfsd-result-model'));
			mixModal.show();
		}else{
			searchSmpXfsdResultByHotcity.execute({sid: $(this).data('sid')});
		}

	})

	// 混舱 xfsd 
	$("#content").on('click', '.mix-cabin', function(){
		searchXfsdAllResultByHotcity.execute({sid: $(this).data('xfsdsid')});
	})

	// 销售日期的【下一步】
	$('#otherModal').on('click', '#set-saleDate', function(){
		var saleDateInput = {};
		$('.saleDate').each(function(){
			saleDateInput[$(this).data('rule')] = $(this).val();
		})
		// 更新
		updatePriceSource.execute({'update': JSON.stringify(saleDateInput), 'hid': hid});
		
		reqPriceSource.execute({'hid': hid});

	})

}

setCommand(eterm.createCommand(eterm.eterm,tpl));

// 所有的计划任务
function mkTable(array, target, wrap, type){

	'use strict';

	if(!array) return;

	let html = '', 
			appendType = type !== ""? type : 'w',
	  	context = wrap !== "" ? wrap : document;

	// 暴露至全局
	cabin = array[0].HC_Cabin.split(',');

	html +=`
		  <table class="${target} table table-hover table-bordered table-responsive">
		  <thead>
				<tr>
					<th>序号</th>
					<th>出发</th>
					<th>到达</th>
					<th>航路</th>
					<th>航空公司</th>
					<th>目标舱位</th>
					<th>计划来源</th>
					<th>运价状态</th>
					<th>舱位状态</th>
					<th>状态</th>
					<th>创建时间</th>
					<th>更新时间</th>
					<th>操作</th>
				</tr>
			</thead>
	`
	for(var i in array){
		var query = JSON.parse(array[i].HC_Query);
		html +=`
				<tr>
					<td>${i}</td>
					<td>${array[i].HC_Depart}</td>
					<td>${array[i].HC_Arrive}</td>
					<td>${array[i].HC_Routing}</td>
					<td>${array[i].HC_Aircompany}</td>
					<td>${array[i].HC_Cabin}</td>
					<td>航空公司：${query? query['aircompany'] : ""} | 出发：${query? query['depart'] : ''} | 区域：${query? query['region'] : ''} | 规则：${query? query['rule']: ''}</td>
					<td>`
		html +=	array[i].HC_XfsdResult_Status == 2 ? `<a href="javascript:void(0)" class="xfsd-result" data-sid="${array[i].HC_XfsdResult_Sid}">全部</a> | <a href="javascript:void(0)" class="simplify-xfsd" data-sid="${array[i].HC_XfsdResult_Sid}">精简</a> `: '等待'
		html +=`</td>
					<td>`
		html += array[i].HC_AvhResult_Status == 2? `<a href="javascript:void(0)" class="avh-result" data-sid="${array[i].HC_AvhResult_Sid}">查看</a>`: '等待'
		html +=`</td>
					<td>${array[i].HC_Status == 2? '完成': '等待'}</td>
					<td>${new Date((array[i].GmtCreate -0)*1000).format("yyyy-MM-dd hh:mm:ss")}</td>
					<td>${new Date((array[i].GmtModified -0)*1000).format("yyyy-MM-dd hh:mm:ss")}</td>
					<td><a href='javascript:void(0)' class='mix-cabin' data-xfsdsid="${array[i].HC_XfsdResult_Sid}" data-avhsid="${array[i].HC_AvhResult_Sid}">混舱</a></td>
				</tr>
		`
	}

	html += '</table>';

	appendType === 'a'? $(context).append(html): $(context).html(html);
}

// xfsd 运价模板
function xfsdTable(array, dom){
	let html = `<div class='${dom}'>`;
	for(var j in array){
		html += `<table class="table table-hover table-bordered table-responsive">
					<tr>
						<th>序号</th>
						<th>fare</th>
						<th>命令</th>
						<th>提前出票</th>
						<th>单程价格</th>
						<th>往返价格</th>
						<th>舱位</th>
						<th>最短停留</th>
						<th>最长停留</th>
						<th>适用截止日期</th>
						<th>退票规则</th>
						<th>可用星期</th>
						<th>出发</th>
						<th>到达</th>
						<th>航空公司</th>
						<th>方向</th>
						<th>创建日期</th>
					</tr>`
		var value ;
		for(var i in array[j]){
			value = array[j][i];
			html += `
				<tr>
						<td>${i}</td>
						<td>${value['FareBasis']}</td>
						<td>${value['Command']}</td>
						<td>${value['xfsd_Advp']}</td>
						<td>${value['xfsd_SingleFee']}</td>
						<td>${value['xfsd_RoundFee']}</td>
						<td>${value['xfsd_Cabin']}</td>
						<td>${value['xfsd_MinStay']}</td>
						<td>${value['xfsd_MaxStay']}</td>
						<td>${value['xfsd_DateStart']}>${value['xfsd_DateEnd']}</td>
						<td>${value['xfsd_Rule']}</td>
						<td>${value['xfsd_Indicator']}</td>
						<td>${value['xfsd_Dep']}</td>
						<td>${value['xfsd_Arr']}</td>
						<td>${value['xfsd_Owner']}</td>
						<td>${value['xfsd_Region']}</td>
						<td>${new Date((value['gmtCreate'] -0)*1000).format("yyyy-MM-dd hh:mm:ss")}</td>
				</tr>
			`
		}
	}
	html += "</div>";
	return html;
}

// avh 舱位模板
function avhTpl(array, dom){ // (data, className, container)
	// 暴露至全局
	avh = array.result;

	let html = "<table class='${dom} table table-hover table-bordered table-responsive'>";
	for( var i in array ){ 
			var avhCabin = eval('['+array[i].avh_Cabin+']')[0];
						
			html += "<tr>";
			html += `
				<td>${i}</td>
				<td>${array[i].avh_Flight}</td>
				<td>${array[i].avh_Dep}</td>
				<td>${array[i].avh_Arr}</td>
				<td>${array[i].avh_DepTime}-${array[i].avh_ArrTime}<!--${array[i].avh_FlightTime}--></td>
				<td>
			`
			// 显示特定舱位
			if(cabin[0] != '' && cabin.length > 0){
				for(var s in cabin){
					if( avhCabin[cabin[s]] ){ // 屏蔽掉无舱位数据
						if( avhCabin[cabin[s]] -0 >3){
							html += "<span style='color:red'>"+cabin[s]+'('+avhCabin[cabin[s]]+")</span>/";
						}else{
							html += cabin[s]+'('+avhCabin[cabin[s]]+")/";
						}
					}
				}
			}
			// 未设置特定舱位
			else{
				for(var s in avhCabin){
					if(avhCabin[s]-0 >3){
						html += "<span style='color:red'>"+s+'('+avhCabin[s]+")</span>/";
					}else{
						html += s+'('+avhCabin[s]+")/";
					}
				}
			}
			html += "</td>";
			html += `<td>${new Date((array[i].gmtModified -0)*1000).format("yyyy-MM-dd hh:mm:ss")}</td>`;
			html += "</tr>";
	}
	html += '</table>';

	$('#modal-content').html(html);
	avhModal.show();
}

// 混舱1：回填销售日期
function mkSaleDateInsertTable(array){
	let html = '', saleDate = '';
	html += `<table class="table table-hover table-bordered table-responsive">
		<thead>
			<tr>
				<th>FareBasis</th>
				<th>命令</th>
				<th>销售日期</th>
			</tr>
		</thead>
	`;

	for(var i in array){
		saleDate = array[i].SaleDate ? array[i].SaleDate: '';
		html += `
			<tr>
				<td>${array[i].FareBasis}</td>
				<td>XS/FSD${array[i].xfsd_Dep}${array[i].xfsd_Arr}//${array[i].xfsd_Owner}/#*${array[i].FareBasis}/${array[i].xfsd_Rule.replace(' ', '')}//# -> XS FSN1//15（销售限制）, XS FSN1//4（航班限制）</td>
				<td><input type='text' class='form-control saleDate' data-rule="${array[i].xfsd_Rule}" value="${saleDate}"></td>
			</tr>
		`
	}

	return html;
}

// --------------------  过期方法 ---------------------
function xfsdTpl(array, dom, show){

	// 暴露至全局
	xfsd_src = array;

	show = show ? true: false;
	let html = "<div class='${dom}'>";
	for(var i in array){
		html += `<table class="table table-hover table-bordered table-responsive">
					<tr>
						<th>序号</th>
						<th>fare</th>
						<th>命令</th>
						<th>提前出票</th>
						<th>单程价格</th>
						<th>往返价格</th>
						<th>舱位</th>
						<th>最短停留</th>
						<th>最长停留</th>
						<th>适用截止日期</th>
						<th>退票规则</th>
						<th>可用星期</th>
						<th>出发</th>
						<th>到达</th>
						<th>航空公司</th>
						<th>方向</th>
						<th>创建日期</th>
					</tr>`
		for(var j in array[i].result){
			var value = array[i]['result'][j];
			html += `
				<tr>
						<td>${j}</td>
						<td>${value['FareBasis']}</td>
						<td>${value['Command']}</td>
						<td>${value['xfsd_Advp']}</td>
						<td>${value['xfsd_SingleFee']}</td>
						<td>${value['xfsd_RoundFee']}</td>
						<td>${value['xfsd_Cabin']}</td>
						<td>${value['xfsd_MinStay']}</td>
						<td>${value['xfsd_MaxStay']}</td>
						<td>${value['xfsd_DateStart']}>${value['xfsd_DateEnd']}</td>
						<td>${value['xfsd_Rule']}</td>
						<td>${value['xfsd_Indicator']}</td>
						<td>${value['xfsd_Dep']}</td>
						<td>${value['xfsd_Arr']}</td>
						<td>${value['xfsd_Owner']}</td>
						<td>${value['xfsd_Region']}</td>
						<td>${new Date((value['gmtCreate'] -0)*1000).format("yyyy-MM-dd hh:mm:ss")}</td>
				</tr>
			`
		}
	}
	html += "</div>";

	if(show){
		$('#modal-content').html(html);
		xfsdModal.show();
	}
}

})

</script>

<{/block}>