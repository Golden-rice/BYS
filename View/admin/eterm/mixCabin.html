<{extends file='../layout.html'}>

<{block name="title"}>合成结果<{/block}>
<{block name="content"}>

<div class="panel panel-default">
  <div class="panel-body">
				<button id='mixCabin' class='btn btn-default' data-toggle="modal" data-target="#outputTplModal">生成OTA模板</button>
	</div>
</div>

<div id="content">**<{$data}>**</div>
<hr>
<div id="org_content"></div>

<!-- 模板弹出框 -->
<div class="modal fade" id="outputTplModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" style='width:1200px'>
        <div class="modal-content">
            <div class="modal-header">
								<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
                <h4 class="modal-title" id="myModalLabel">OTA模板</h4>
            </div>
            <div class="modal-body ">
            	<!-- 选择模板 -->
            	<div class="form-inline">
		            <div class="form-group">
									<select class="form-control" style="width: 200px" id='selectTpl'>
										<option value='0'>请选择OTA模板...</option>
									  <option value='1'>淘宝OTA模板</option>
									  <option value='2'>携程OTA模板</option>
									</select>
								</div>
								<div class="form-group">
									<select class="form-control" style="width: 200px" id='selectTplType'>
										<option value='0'>中转</option>
									  <option value='1'>直达</option>
									</select>
								</div>
								<div class="form-group">
									<button id='selectTplOption' class="btn btn-primary">选择</button>
								</div>
							</div>
							<hr>
							<!-- 选择模板 end-->
							<div id="OTAtpl"></div>
            </div>
            <div class="modal-footer">
            		<button id='outputTpl' class="btn btn-primary">生成</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>


<!-- 混舱弹出框 END -->

<!-- 加载OTA模板 -->
<script src='__PUBLIC__js/otaTpl.js?randowId='></script>

<script>
var data = eval(<{$data}>);
var org_data = eval(<{$org_data}>)


// 生成OTA模板
require(['eterm'], function(eterm){

var selectTpl, selectTranlate, selectTplType, selectTplName, selectTplTypeName;
console.log(data);
console.log(org_data);

list(data, 'table', "#content", 'w');
for(var i in org_data ){
	for(var end in org_data[i]){
		list_org(org_data[i][end], 'table', "#org_content", 'a');
	}
}


$('#selectTplOption').click(function(){

	if( $('#selectTpl').find('option:selected').val() === undefined){ return }

	// 选择模板
	switch ( $('#selectTpl').find('option:selected').val() ){
		case "1" : {
			selectTplName = "taobao";
			break;
		}
		case "2" : {
			selectTplName = "xiecheng";
			break;
		}
	}

	// 直达 中转
	switch ( $('#selectTplType').find('option:selected').val() ){
		case "0" : 
			selectTplType = tpl[selectTplName+'Transit'];
			selectTplTypeName = 'Transit';
			break;
		case "1" : 
			selectTplType = tpl[selectTplName+'Direct'];
			selectTplTypeName = 'Direct';
			break;
	}
	selectTpl = tpl[selectTplName];
	selectTranlate = translate[selectTplName];
	renderTpl(selectTranlate, selectTplType)
	
})


var setCommend = function(command){

// 按照模板生成数据
$('#outputTpl').click(function(){
	if(selectTpl === undefined){
		alert('未选择模板')
		return;
	}

	for (var name in selectTpl){
		selectTpl[name] = $('#'+name).val();
	}

	command.mixCabinByTpl(selectTpl, selectTplName, selectTplTypeName)
})

}

setCommend(eterm.createCommand(eterm.eterm));

function renderTpl(translate, tplType){

	'use strict';

	if(translate == undefined || tplType == undefined ){ return ; }

	let html = "";
	html += `<table class="table table-hover table-bordered table-responsive">`
	for(var name in translate){
		html += `
			<tr>
				<td>${translate[name]}</td>
				<td><input type='text' id="${name}" class="form-control" value="${tplType[name]}"></td>
			<tr>
		`
	}
	html += `</table>`
	$('#OTAtpl').html(html)
}

function list(array, dom, wrap, type){
	// array: 返回数据中待渲染数组
	// dom: 为渲染模板起名
	// context: 指定渲染容器
	// appendType: 回填模式 w代表覆盖，a代表追加

		"use strict";
		// ES6 

		let html = '',
				appendType = type !== ""? type : 'w',
			  context = wrap !== "" ? wrap : document;

		// for(let arr in array){
			html += `<table class="${dom} table-hover table-bordered table-responsive">
				<tr>
					<th>fare</th>
					<th>提前出票</th>
					<th>单程价格</th>
					<th>往返价格</th>
					<th>舱位</th>
					<th>最短停留</th>
					<th>最长停留</th>
					<th>适用截止日期</th>
					<th>去程可用星期</th>
					<th>返程可用星期</th>
					<th>航程</th>

				</tr>`
			for(let line =0; line< array['length']; line++){
				html += `
				<tr class='line'>
					<td class='fare'>${array[line]['fare']}</td>
					<td class='ADVPDay'>${array[line]['ADVPDay']}</td>
					<td class='singleLineFee'>${array[line]['singleLineFee']}</td>
					<td class='backLineFee'>${array[line]['backLineFee']}</td>
					<td class='seat'>${array[line]['seat']}</td>
					<td class='minStay'>${array[line]['minStay']}</td>
					<td class='maxStay'>${array[line]['maxStay']}</td>
					<td class='allowDate'>${array[line]['allowDateStart']} - ${array[line]['allowDateEnd']}</td>
					<td class='allowWeek'>${array[line]['allowWeek_1']}</td>
					<td class='allowWeek'>${array[line]['allowWeek_2']}</td>
					<td class='airRrange'>${array[line]['start']}`

					// 第一段中转点
					if ( array[line]['stay'] !== "" ){
						html +=` - ${array[line]['stay']}`;
					}

					if( array[line]['end_2'] ){
						html +=` - ${array[line]['end']} , ${array[line]['end_2']}`;
					}else{
						html +=` - ${array[line]['end']}`;
					}


					// 第二个中转点
					if(array[line]['stay_2'] ){
						html +=` - ${array[line]['stay_2']}`;
					}else if( array[line]['stay'] !== "" && !array[line]['end_2'] ){
						html +=` - ${array[line]['stay']}`;
					}

					// 目的地
					if(array[line]['start_2']){
						html += ` - ${array[line]['start_2']}`
					}else{
						html += ` - ${array[line]['start']}`
					}

					html +=`</td></tr>`
			}
			html += `</table>`
		// }

		if(appendType === 'w'){
			$(context).html(html);
		}
		else if(appendType === 'a'){
			$(context).append(html);
		}
}

function list_org(array, dom, wrap, type){
	// array: 返回数据中待渲染数组
	// dom: 为渲染模板起名
	// context: 指定渲染容器
	// appendType: 回填模式 w代表覆盖，a代表追加


		"use strict";
		// ES6 

		let html = '',
				appendType = type !== ""? type : 'w',
			  context = wrap !== "" ? wrap : document;


			html += `<table class="${dom} table-hover table-bordered table-responsive">
				<tr>
					<th>fare</th>
					<th>提前出票</th>
					<th>单程价格</th>
					<th>往返价格</th>
					<th>舱位</th>
					<th>最短停留</th>
					<th>最长停留</th>
					<th>适用截止日期</th>
					<th>可用星期</th>
					<th>航程</th>
				</tr>`

			for(let line =0; line< array['length']; line++){
				html += `
				<tr class='line'>
					<td class='fare'>${array[line]['fare']}</td>
					<td class='ADVPDay'>${array[line]['ADVPDay']}</td>
					<td class='singleLineFee'>${array[line]['singleLineFee']}</td>
					<td class='backLineFee'>${array[line]['backLineFee']}</td>
					<td class='seat'>${array[line]['seat']}</td>
					<td class='minStay'>${array[line]['minStay']}</td>
					<td class='maxStay'>${array[line]['maxStay']}</td>
					<td class='allowDate'>${array[line]['allowDateStart']} - ${array[line]['allowDateEnd']}</td>
					<td class='allowWeek'>${array[line]['allowWeek']}</td>
					<td class='airRrange'>${array[line]['start']}`
					if (array[line]['stay'] && array[line]['stay'] !== ""){
						html +=` - ${array[line]['stay']} - ${array[line]['end']} - ${array[line]['stay']} - `;
					}else{
						html +=` - ${array[line]['end']} - `;
					}
					html +=`${array[line]['start']}</td>
				</tr>
				`
			}
			html += `</table>`

		if(appendType === 'w'){
			$(context).html(html);
		}
		else if(appendType === 'a'){
			$(context).append(html);
		}
}

})

</script>

<{/block}>