<{extends file='../layout.html'}>

<{block name="title"}>航路<{/block}>
<{block name="content"}>

<div class="panel panel-default">
	<div class="panel-body">

		<div class="form-inline">

			<div class="input-group">
					<span class="input-group-addon" id="input-start">出发</span><input type="text" name="start" id="start"  class='form-control' onblur="upper(this)" style='width:100px' aria-describedby="input-start" placeholder='机场代码'>
					<span class="input-group-addon" id="input-end">到达</span><input type="text" name="end" id="end" class='form-control' onblur="upper(this)" style='width:100px' aria-describedby="input-end" placeholder='机场代码'>
					<span class="input-group-addon" id="input-aircompany">航空公司</span><input type="text" name="airCompany" id="airCompany" placeholder="两字码" class='form-control' onblur="upper(this)" style='width:100px' aria-describedby="input-aircompany">
			</div>

			<div class="input-group">
				<input type="submit" value="查询" name='dosubmit' id='dosubmit' class="btn btn-primary">
			</div>

			<div class="input-group">
				<button id='test' class='btn btn-default'>test</button>
			</div>

		</div>
		<!-- form-inline -->
	</div>
	<!-- "panel-body -->
</div>
<!-- panel -->

<div id="content-progress"></div>
<div id="content"></div>
    
<!-- other modal -->
<div class="modal fade" id="otherModal" tabindex="-1" role="dialog" aria-labelledby="modalLabel">
  <div class="modal-dialog modal-lg" role="document" >
    <div class="modal-content">

      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="modalLabel"> </h4>
      </div>
      <!-- modal header -->

      <div class="modal-body">
        <div id="modal-content">
            

        </div>
      </div>
      <!-- modal body -->

      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
      </div>
      <!-- modal footer -->

    </div>
  </div>
</div>
<!-- other modal end -->

<script>
require(['eterm', 'dt'], function (eterm, dt){

// 弹出框   
var OtherModel = function(title, content, footer){

    $("#otherModal .modal-title").html(title);
    $("#otherModal #modal-content").html(content);
    $("#otherModal .modal-footer").html(footer);

    return {
        hide: function(){
            $("#otherModal").modal("hide");
        },
        show: function(){
            $("#otherModal").modal();
        }
    }
}

var setCommend = function(command){

$('#test').click(function(){
	// 测试
	$('#airCompany').val('UA');
	$('#start').val('PEK');
	$('#end').val('LAX')
	command.searchRouting({
			airCompany: $('#airCompany').val(),
			dep: $('#start').val(),
			arr: $('#end').val()
	})
})

	// 开始查询
	$('#dosubmit').click(function(){
		command.searchRouting({
			airCompany: $('#airCompany').val(),
			dep: $('#start').val(),
			arr: $('#end').val()
		})
	})
}

var tpl = {
	mkTable:mkTable,
}

// 配置setCommand()
// 装载模板mkTable()
setCommend(eterm.createCommand(eterm.eterm,tpl));

function mkTable(data, dom, wrap, type){

	let html = '', 
		routingBy1 = [], outbound = [], inbound = [],
		appendType = type !== ""? type : 'w',
	  	context = wrap !== "" ? wrap : document;


  	// 匹配1个中转
  	var matchRoutingPart = function(firstPart, secondPart){
  		var dep = '', arr = '', cur_arr = '', cur_dep = '', routingPart = [];
	  	for(var i in firstPart){
	  		firstDepartrue = firstPart[i];
	  		dep            = firstDepartrue.Fli_Dep;
	  		cur_arr        = firstDepartrue.Fli_Arr;

	  		for (var j in secondPart){
	  			secondDeparture  = secondPart[j];
	  			cur_dep          = secondDeparture.Fli_Dep;
	  			arr              = secondDeparture.Fli_Arr;

	  			if(cur_arr == cur_dep ){
			  		var cur_arr_time = new Date(2017, 8, 21, firstDepartrue.Fli_ArrTime.substr(0,2), firstDepartrue.Fli_ArrTime.substr(2,2), 0).getTime();
		  			var cur_dep_time = new Date(2017, 8, 21, secondDeparture.Fli_DepTime.substr(0,2), secondDeparture.Fli_DepTime.substr(2,2), 0).getTime();

	  				if( cur_dep_time - cur_arr_time > 0 && cur_arr !== arr){
		  				routingPart.push({
		  					'routing': dep + '-' + cur_arr + '-' + arr,
		  					'flight': firstDepartrue.Fli_Flight + '(' + firstDepartrue.Fli_SupportType + ')' + '-' + secondDeparture.Fli_Flight + '(' + secondDeparture.Fli_SupportType + ')',
		  					'time': firstDepartrue.Fli_DepTime + '-' + firstDepartrue.Fli_ArrTime + '(' + firstDepartrue.Fli_Fly + ')'+ '-' + secondDeparture.Fli_DepTime + '-' + secondDeparture.Fli_ArrTime + '(' + secondDeparture.Fli_Fly + ')',
                            'FlightNumber': firstDepartrue.Fli_Flight + '+' + secondDeparture.Fli_Flight,
		  				})
	  				}
	  			} 

	  		} 

	  	} 
  		return routingPart;
  	}

  	// 匹配去程
  	outbound = matchRoutingPart(data.outboundFirst, data.outboundSecond);
  	// 匹配回程
  	inbound  = matchRoutingPart(data.inboundFirst, data.inboundSecond);

  	// 内积
  	for (var i in outbound){
  		for(var j in inbound){
  			routingBy1.push ({
  				'outboundRouting': outbound[i].routing,
  				'outboundFlight': outbound[i].flight,
  				'outTime': outbound[i].time,
  				'inboundRouting': inbound[j].routing,
  				'inboundFlight': inbound[j].flight,
  				'inboundTime': inbound[j].time,
  				'routing': outbound[i].routing + '-' + inbound[j].routing,
                'action': '<a href="#" class="buildFsi" data-json='+JSON.stringify({
                    'FlightNumberOut': outbound[i].FlightNumber,
                    'FlightInfoOut': outbound[i].routing,
                    'SeatClassOut': '/',
                    'FlightNumberIn': inbound[j].FlightNumber,
                    'FlightInfoIn': inbound[j].routing,
                    'SeatClassIn': '/',
                })+'>fsi</a>',
  			}) 
  		}
  	}


  	html += `
  	<div class="${dom}">

	    <!-- 一次中转 -->
		    <div class="row">
			<div class="col-lg-12">
				<div class="panel panel-default">
				    <div class="panel-heading">数据库拼接航路：一次中转 </div>
				    <div class='panel-body'>
					    <table class="routing-by1-table table table-hover table-bordered table-responsive">
					    <thead>
                          <tr>
                            <td colspan ='3'>去程</td>
                            <td colspan ='3'>回程</td>
                            <td rowspan ='2'>总航路</td>
                            <td rowspan ='2'>操作</td>
                          </tr>
                          <tr>
                            <td>航程</td>
                            <td>航班号</td>
                            <td>时间</td>

                            <td>航程</td>
                            <td>航班号</td>
                            <td>时间</td>
                          </tr>
						</thead>
						</table>
                    </div>
				</div>
			</div>
		</div>
		<!-- 一次中转 -->


		<!-- 携程数据 -->
  		<div class="row">
			<div class="col-lg-12">
				<div class="panel panel-default">
				    <div class="panel-heading">携程数据</div>
				    <div class='panel-body'>
					    <table class="routing-ctrip-table table table-hover table-bordered table-responsive">
					    <thead>
                          <tr>
                            <td colspan ='3'>去程</td>
                            <td colspan ='3'>回程</td>
                          </tr>
                          <tr>
                            <td>航程</td>
                            <td>航班号</td>
                            <td>旅行日期</td>

                            <td>航程</td>
                            <td>航班号</td>
                            <td>旅行日期</td>
                          </tr>
						</thead>
						</table>
					</div>
				</div>
			</div>
        </div>
		<!-- 携程数据-->

		</div>
  	`;

	if(appendType === 'w'){
		$(context).html(html);
	}
	else if(appendType === 'a'){
		$(context).append(html);
	}		

	$('.routing-by1-table').DataTable({
        // responsive: true,
        data: routingBy1,
        columns: [
            { data: "outboundRouting" },
            { data: "outboundFlight" },
            { data: "outTime" },
            { data: "inboundRouting" },
            { data: "inboundFlight" },
            { data: "inboundTime" },
            { data: "routing" },
            { data: "action" },
        ]
    });  	

  	// 匹配携程数据
  	if(data.lowprice.LowPriceModel){
  		var ctripRouting = data.lowprice.LowPriceModel;
  		for(var q in ctripRouting){
  			ctripRouting[q].OutboundTravelDate = data.ctripTravelDate.outboundTravelDate;
  			ctripRouting[q].InboundTravelDate  = data.ctripTravelDate.inboundTravelDate;
  		}

	    $('.routing-ctrip-table').DataTable({
	        data: ctripRouting,
	        columns: [
	            { data: "FlightInfoOut" },
	            { data: "FlightNumberOut" },
	            { data: "OutboundTravelDate" },
	            { data: "FlightInfoIn" },
	            { data: "FlightNumberIn" },
	            { data: "InboundTravelDate" },
	        ]
	    }); 
  	}


}


    // 生成 fsi
    $("#content").on("click", ".buildFsi", function(){
        // 只生成往返
        var json = $(this).data("json");
        if( JSON.stringify(json) === "{}"){
            return;
        }

        var targetData             = json,     
            OutboundTravelDateOrg  = (new Date())+"",     
            OutboundTravelDate     = OutboundTravelDateOrg.substr(8,2)+OutboundTravelDateOrg.substr(4,3).toUpperCase();

        var InboundTravelDateOrg   = (new Date())+"",
            InboundTravelDate      = InboundTravelDateOrg.substr(8,2)+InboundTravelDateOrg.substr(4,3).toUpperCase();


        var fsi = "XS FSI/"+$("#airCompany").val()+"\r"; 

        // 去程中间段
        if(/\+/.test(targetData.FlightNumberOut)){
                // 航班号
            var out = /(\w{2})(\d+)\+(\w{2})(\d+)/.exec(targetData.FlightNumberOut),
                flightOut1 = out[1], out1 = out[2], flightOut2 = out[3], out2 = out[4],

                // 舱位
                seatClassOut  = targetData.SeatClassOut,
                seatClassOut1 = seatClassOut, seatClassOut2 = seatClassOut,

                // 地点
                dep = /(\w{3})-(\w{3})-(\w{3})/.exec(targetData.FlightInfoOut),
                start1 = dep[1], stay1 = dep[2], end1 = dep[3];

            fsi +="S "+flightOut1+"   "+out1+seatClassOut1+OutboundTravelDate+" "+start1+"0100 0200"+stay1+"0X    76W \r" 
            fsi +="S "+flightOut2+"   "+out2+seatClassOut2+OutboundTravelDate+" "+stay1 +"0300 0400"+end1 +"0S    76W \r" 

        }
        // 去程无中间段
        else{
                // 航班号
            var out = /(\w{2})(\d+)/.exec(targetData.FlightNumberOut),
                flightOut = out[1], out = out[2],

                // 舱位
                seatClassOut = targetData.SeatClassOut,

                // 地点
                dep = /(\w{3})-(\w{3})/.exec(targetData.FlightInfoOut),
                start1 = dep[1], end1 = dep[2];


            fsi +="S "+flightOut+"   "+out+seatClassOut+OutboundTravelDate+" "+start1+"0100 0200"+end1+"0S    76W \r" 

        }

        // 判断是否有回程
        if(targetData.FlightNumberIn){

        // 回程中间段
        if(/\+/.test(targetData.FlightNumberIn)){
                // 航班号
            var inb = /(\w{2})(\d+)\+(\w{2})(\d+)/.exec(targetData.FlightNumberIn),
                flightIn1 = inb[1], inb1 = inb[2], flightIn2 = inb[3], inb2 = inb[4],

                // 舱位
                seatClassIn  = targetData.SeatClassIn,
                seatClassIn1 = seatClassIn, seatClassIn2 = seatClassIn,

                // 地点
                arr = /(\w{3})-(\w{3})-(\w{3})/.exec(targetData.FlightInfoIn),
                start2 = arr[1], stay2 = arr[2], end2 = arr[3];

            fsi +="S "+flightIn1+"   "+inb1+seatClassIn1+InboundTravelDate +" "+start2+"0100 0200"+stay2+"0X    76W \r" 
            fsi +="S "+flightIn2+"   "+inb2+seatClassIn2+InboundTravelDate +" "+stay2 +"0300 0400"+end2 +"0S    76W \r" 
        }
        // 回程无中间段
        else{
                // 航班号
            var inb = /(\w{2})(\d+)/.exec(targetData.FlightNumberIn),
                flightIn = inb[1], inb = inb[2] 

                // 舱位
                seatClassIn = targetData.SeatClassIn,

                // 地点
                arr = /(\w{3})-(\w{3})/.exec(targetData.FlightInfoIn),
                start2 = arr[1], end2 = arr[2];


            fsi +="S "+flightIn+"   "+inb+seatClassIn +InboundTravelDate +" "+start2+"0300 0400"+end2+"0S    76W \r"
        }
                                             

        }
        // console.log(fsi);

        // 弹出
        var fsiModal = new OtherModel("结果",
        `
            <textarea  class="form-control" rows="6">${fsi}</textarea>
        `
        ,`<button type="button" class="btn btn-default"  data-dismiss="modal">关闭</button>`)

        fsiModal.show();
    })

  $(function(){
    // 导航
    $('.nav>li').removeClass('active');
    $('.nav>.basis').addClass('active');
  })

})



</script>
<{/block}>